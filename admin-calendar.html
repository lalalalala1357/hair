<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è¡Œäº‹æ›†ç®¡ç† - å¯è‰å…’ Hair Salon</title>
<style>
:root{
  --bg:#f7fff7;
  --card:#ffffff;
  --accent:#a8e6cf;
  --muted:#666;
  --btn:#ccc;
  --today-bg: #fff3cd; /* ä»Šæ—¥é«˜äº®é¡è‰² */
}
body{font-family:Arial, Helvetica, sans-serif;background:var(--bg);margin:0;padding:0;color:#333}

/* header/nav */
header{background:#a8e6cf;padding:15px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;}
header h1{margin:0;color:#4a7c53;font-weight:bold;font-size:18px;}

nav {
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
}

nav ul{
  list-style:none;
  display:flex;gap:12px;
  margin:0;
  padding:0;
  white-space:nowrap;
}
nav a{
  text-decoration:none;
  color:#333;
  font-weight:bold;
  padding:6px 12px;
  border-radius:4px;
  flex-shrink: 0;
}
nav a:hover, nav a.active{background:#7bd8a2;color:#fff;}

/* è¡Œäº‹æ›† */
#controls { text-align:center; margin:20px 0; }
#calendar { 
  display:grid; 
  grid-template-columns:repeat(7,1fr); 
  gap:4px; 
  max-width:700px; 
  margin:0 auto; 
  padding: 0 5px;
}
.week-cell, .calendar-cell { 
  padding:10px; 
  border:1px solid #ccc; 
  text-align:center; 
  border-radius: 4px;
}
.week-cell { background:#e0f2e9; font-weight:bold; }
.calendar-cell { 
  background:#fff; 
  cursor:pointer; 
  position:relative; 
  min-height: 80px; /* å¢åŠ é«˜åº¦è®“æ¨™ç±¤æ›´å¥½çœ‹ */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
}
.calendar-cell.is-today {
  background: var(--today-bg);
  border: 2px solid #ffc107;
}
.calendar-cell:hover { background:#7bd8a2; color:#000; }

.date-num { font-weight: bold; margin-bottom: 5px; }

.label-container {
  display: flex;
  flex-direction: column;
  gap: 2px;
  width: 100%;
  align-items: center;
}
.label { 
  color:#fff; 
  font-size:0.75rem; 
  padding:2px 6px; 
  border-radius:10px; 
  width: 80%;
  max-width: 60px;
}

button { 
  margin:5px 5px 0 0; 
  padding:6px 12px; 
  background:#7bd8a2; 
  border:none; 
  color:#fff; 
  border-radius:4px; 
  cursor:pointer; 
}
button:hover { background:#5bb174; }

/* Modal */
#appointmentModal {
  display:none; 
  position:fixed; 
  top:50%; left:50%; 
  transform:translate(-50%,-50%);
  background:#fff; 
  border:1px solid #ccc; 
  padding:20px; 
  border-radius:8px; 
  width: 90%;
  max-width:420px; 
  z-index:100; 
  max-height:85vh; 
  overflow-y:auto;
  box-shadow: 0 0 20px rgba(0,0,0,0.2);
}
#appointmentModal h3 { margin-top:0; border-bottom: 2px solid #a8e6cf; padding-bottom: 10px;}
.apptRow { 
  border-bottom:1px solid #eee; 
  padding:10px 0; 
  display:flex; 
  flex-direction:column; 
  gap:6px; 
}
.apptRow:last-child { border-bottom: none; }
.apptInfo { font-size: 1rem; }
.apptStatus { font-size: 0.85rem; color: #666; }
.apptBtnGroup { display:flex; gap:8px; margin-top:5px; }
.apptRow button { padding:6px 12px; border:none; border-radius:5px; font-weight:bold; cursor:pointer; font-size: 0.85rem; }
.apptDone { background:#5cb85c; color:#fff; }
.apptCancel { background:#ff5c5c; color:#fff; }
.apptDelete { background:#e2e2e2; color:#333; }

#modalOverlay {
  display:none; position:fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.4);
  z-index:99;
  backdrop-filter: blur(2px);
}

/* æ–°å¢é ç´„è¡¨å–® */
#newApptForm {
  background: #f9f9f9;
  padding: 15px;
  border-radius: 8px;
  margin-top:15px;
  display: flex;
  flex-direction: column;
  gap:12px;
  border: 1px solid #eee;
}
#newApptForm label {
  display: flex; flex-direction: column;
  font-weight: bold; font-size: 0.9rem; color: #333;
}
#newApptForm input, #newApptForm select {
  padding: 8px; margin-top: 4px;
  border: 1px solid #ccc; border-radius: 4px;
}
#addApptBtn { background: #3399ff; color: #fff; }
#addApptBtn:hover { background: #287acc; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <h1>å¯è‰å…’ Hair Salon - ç®¡ç†å¾Œå°</h1>
  <nav>
    <ul>
      <li><a href="admin-calendar.html" class="active">è¡Œäº‹æ›†ç®¡ç†</a></li>
      <li><a href="vip_test.html">VIPç®¡ç†</a></li>
      <li><a href="admin-news.html">å…¬å‘Šç®¡ç†</a></li>
      <li><a href="message.html">ç•™è¨€ç®¡ç†</a></li>
    </ul>
  </nav>
</header>

<div id="controls">
  <button id="prevMonth">&lt; ä¸Šå€‹æœˆ</button>
  <span id="monthLabel" style="font-weight:bold; margin:0 15px; font-size: 1.2rem;"></span>
  <button id="nextMonth">ä¸‹å€‹æœˆ &gt;</button>
  <button id="refreshBtn" style="background-color: #3399ff;">â†» åˆ·æ–°</button>
</div>

<div id="calendar"></div>

<div id="modalOverlay"></div>

<div id="appointmentModal">
  <h3 id="modalDate"></h3>
  <div id="modalContent"></div>

  <div id="newApptForm">
    <h4 style="margin:0 0 10px 0;">â• æ–°å¢é ç´„</h4>
    <label>å§“å:<input type="text" id="newName" placeholder="å®¢æˆ¶å§“å"></label>
    <label>é›»è©±:<input type="text" id="newPhone" placeholder="09xx..."></label>
    <label>æ™‚é–“:<select id="newTime"></select></label>
    <label>æœå‹™:
      <select id="newService">
        <option value="å‰ªé«®">å‰ªé«®</option>
        <option value="æ´—é«®">æ´—é«®</option>
        <option value="ç‡™é«®">ç‡™é«®</option>
        <option value="æŸ“é«®">æŸ“é«®</option>
        <option value="è­·é«®">è­·é«®</option>
        <option value="é ­çš®è­·ç†">é ­çš®è­·ç†</option>
      </select>
    </label>
    <div style="display:flex; gap:10px; margin-top:5px;">
        <button id="addApptBtn" style="flex:1;">ç¢ºèªæ–°å¢</button>
        <button onclick="closeModal()" style="background:#ccc; color:#333; flex:1;">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
// --- Firebase è¨­å®š ---
const firebaseConfig = {
  apiKey: "AIzaSyCfxDOOzTLbmQRfvW275hJrtOnX_t-6-yc",
  authDomain: "hsinformation.firebaseapp.com",
  projectId: "hsinformation"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- å…¨åŸŸè®Šæ•¸ ---
let appointments = {};
let today = new Date();
let currentYear = today.getFullYear();
let currentMonth = today.getMonth();
let selectedDay = '';
const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

// --- åˆå§‹åŒ–æª¢æŸ¥ ---
checkAuthAndLoad();

function checkAuthAndLoad() {
    if(!localStorage.getItem('calendar_authenticated')){
        const password = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼');
        if(password === 'clear0921'){
            localStorage.setItem('calendar_authenticated','true');
            loadAppointments(currentYear, currentMonth);
        } else {
            alert('å¯†ç¢¼éŒ¯èª¤ï¼');
            document.body.innerHTML='<h2 style="text-align:center;margin-top:100px;color:red;">å¯†ç¢¼éŒ¯èª¤ï¼Œæ‹’çµ•å­˜å–ã€‚</h2>';
        }
    } else {
        loadAppointments(currentYear, currentMonth);
    }
}

// --- è³‡æ–™è®€å– ---
async function loadAppointments(year, month){
  // é¡¯ç¤ºè®€å–ä¸­ç‹€æ…‹ (å¯é¸)
  document.getElementById('monthLabel').textContent = "è®€å–ä¸­...";

  const start = `${year}-${String(month+1).padStart(2,'0')}-01`;
  const end = `${year}-${String(month+1).padStart(2,'0')}-31`;
  
  try {
    const snapshot = await db.collection('appointments')
        .where('date', '>=', start)
        .where('date', '<=', end)
        .get();

    appointments = {};
    snapshot.forEach(doc=>{
        const data = doc.data();
        if(!appointments[data.date]) appointments[data.date]=[];
        appointments[data.date].push({...data, id: doc.id});
    });

    buildCalendar(year, month);
  } catch (error) {
    console.error("è®€å–å¤±æ•—:", error);
    alert("è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
  }
}

// --- å»ºæ§‹æ—¥æ›† ---
function buildCalendar(year, month){
  const calendar = document.getElementById('calendar');
  calendar.innerHTML='';
  document.getElementById('monthLabel').textContent=`${year} å¹´ ${month+1} æœˆ`;

  // 1. æ˜ŸæœŸæ¨™é¡Œ
  weekDays.forEach(d=>{
    const cell=document.createElement('div');
    cell.classList.add('week-cell');
    cell.textContent=d;
    calendar.appendChild(cell);
  });

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startWeek = firstDay.getDay(); // 0-6
  const totalDays = lastDay.getDate();
  
  // è¨ˆç®—ã€Œä»Šå¤©ã€çš„å­—ä¸²ä»¥ä¾¿é«˜äº®é¡¯ç¤º
  const todayDate = new Date();
  const todayStr = `${todayDate.getFullYear()}-${String(todayDate.getMonth()+1).padStart(2,'0')}-${String(todayDate.getDate()).padStart(2,'0')}`;

  // 2. ç©ºç™½æ ¼å­ (ä¸Šå€‹æœˆå‰©é¤˜)
  for(let i=0; i<startWeek; i++){
    const cell=document.createElement('div');
    cell.classList.add('calendar-cell');
    cell.style.background='#f9f9f9';
    calendar.appendChild(cell);
  }

  // 3. æ—¥æœŸæ ¼å­
  for(let d=1; d<=totalDays; d++){
    const dayStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cell=document.createElement('div');
    cell.classList.add('calendar-cell');
    
    // æ¨™è¨˜ä»Šå¤©
    if(dayStr === todayStr) {
        cell.classList.add('is-today');
    }

    const dateNum = document.createElement('div');
    dateNum.classList.add('date-num');
    dateNum.textContent = d;
    cell.appendChild(dateNum);

    const dayAppts = appointments[dayStr] || [];
    
    // æ¨™ç±¤å®¹å™¨
    const labelContainer = document.createElement('div');
    labelContainer.classList.add('label-container');

    if(dayAppts.length > 0){
      const completedCount = dayAppts.filter(a=>a.status==='å·²å®Œæˆ').length;
      const pendingCount = dayAppts.filter(a=>a.status==='å·²é ç´„').length;

      if(pendingCount>0){
        const label = document.createElement('div');
        label.classList.add('label');
        label.style.background='#ff5c5c';
        label.textContent = `${pendingCount} é ç´„`;
        labelContainer.appendChild(label);
      }
      if(completedCount>0){
        const label = document.createElement('div');
        label.classList.add('label');
        label.style.background='#5cb85c';
        label.textContent = `${completedCount} å®Œæˆ`;
        labelContainer.appendChild(label);
      }
    }
    cell.appendChild(labelContainer);

    cell.addEventListener('click', ()=>manageDay(dayStr));
    calendar.appendChild(cell);
  }
}

// --- é ç´„ç®¡ç† Modal ---
function manageDay(dayStr){
  selectedDay = dayStr;
  let dayAppointments = appointments[dayStr] || [];
  
  // *** é—œéµå„ªåŒ–ï¼šä¾ç…§æ™‚é–“æ’åº ***
  dayAppointments.sort((a, b) => {
      return a.time.localeCompare(b.time);
  });

  const modal = document.getElementById('appointmentModal');
  const overlay = document.getElementById('modalOverlay');
  const content = document.getElementById('modalContent');
  const modalDate = document.getElementById('modalDate');
  
  // é¡¯ç¤ºæ˜ŸæœŸå¹¾
  const dateObj = new Date(dayStr);
  const dayOfWeek = weekDays[dateObj.getDay()];
  
  modalDate.textContent = `ğŸ“… ${dayStr} (${dayOfWeek})`;
  content.innerHTML='';

  if(dayAppointments.length === 0) {
      content.innerHTML = '<p style="text-align:center;color:#888;">å°šç„¡é ç´„è³‡æ–™</p>';
  }

  dayAppointments.forEach((a,i)=>{
    const row = document.createElement('div');
    row.classList.add('apptRow');
    
    // ç‹€æ…‹é¡è‰²
    let statusColor = '#333';
    if(a.status === 'å·²å®Œæˆ') statusColor = 'green';
    if(a.status === 'å·²å–æ¶ˆ') statusColor = 'red';

    row.innerHTML = `
      <div class="apptInfo">
        <strong>${a.time}</strong> - ${a.memberName} 
        <span style="font-size:0.8rem; color:#666;">(${a.memberId})</span>
      </div>
      <div class="apptStatus">
         é …ç›®: <b>${a.service}</b> | ç‹€æ…‹: <span style="color:${statusColor};font-weight:bold;">${a.status}</span>
      </div>
    `;

    const btnGroup = document.createElement('div');
    btnGroup.classList.add('apptBtnGroup');

    if(a.status !== 'å·²å®Œæˆ') {
        const btnDone = document.createElement('button');
        btnDone.textContent='âœ… å®Œæˆ';
        btnDone.classList.add('apptDone');
        btnDone.onclick = ()=>updateAppointmentStatus(a.id,'å·²å®Œæˆ');
        btnGroup.appendChild(btnDone);
    }

    if(a.status !== 'å·²å–æ¶ˆ') {
        const btnCancel = document.createElement('button');
        btnCancel.textContent='ğŸš« å–æ¶ˆ';
        btnCancel.classList.add('apptCancel');
        btnCancel.onclick = ()=>updateAppointmentStatus(a.id,'å·²å–æ¶ˆ');
        btnGroup.appendChild(btnCancel);
    }

    const btnDelete = document.createElement('button');
    btnDelete.textContent='ğŸ—‘ï¸ åˆªé™¤';
    btnDelete.classList.add('apptDelete');
    btnDelete.onclick = ()=>deleteAppointment(dayStr, i); // å‚³å…¥ index ç”¨æ–¼æ¨‚è§€æ›´æ–°ï¼Œä½†å¯¦éš›åˆªé™¤ç”¨ ID

    btnGroup.appendChild(btnDelete);
    row.appendChild(btnGroup);
    content.appendChild(row);
  });

  populateTimeSelect();
  // é‡ç½®è¡¨å–®
  document.getElementById('newName').value='';
  document.getElementById('newPhone').value='';
  document.getElementById('newService').selectedIndex=0;
  
  overlay.style.display='block';
  modal.style.display='block';
}

// --- CRUD æ“ä½œ ---
async function updateAppointmentStatus(apptId, newStatus){
  try {
      await db.collection('appointments').doc(apptId).update({ status: newStatus });
      closeModal();
      loadAppointments(currentYear,currentMonth); // é‡æ–°è®€å–ç¢ºä¿è³‡æ–™ä¸€è‡´
  } catch(e) {
      alert("æ›´æ–°å¤±æ•—ï¼š" + e.message);
  }
}

async function deleteAppointment(dayStr, index){
  if(!confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†é ç´„å—ï¼Ÿ(æ­¤æ“ä½œç„¡æ³•å¾©åŸ)")) return;

  const appt = appointments[dayStr][index];
  try {
      await db.collection('appointments').doc(appt.id).delete();
      closeModal();
      loadAppointments(currentYear,currentMonth);
  } catch(e) {
      alert("åˆªé™¤å¤±æ•—ï¼š" + e.message);
  }
}

document.getElementById('addApptBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('newName').value.trim();
  const phone = document.getElementById('newPhone').value.trim();
  const time = document.getElementById('newTime').value;
  const service = document.getElementById('newService').value;
  
  if(!name||!phone||!time||!service){ alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); return; }

  const dayStr = selectedDay;
  // æª¢æŸ¥æœ¬åœ°æ˜¯å¦æœ‰æ™‚é–“è¡çª (ç°¡å–®æª¢æŸ¥)
  const conflict = (appointments[dayStr]||[]).some(a=> a.time === time && a.status !== 'å·²å–æ¶ˆ');
  if(conflict){ 
      if(!confirm(`æ­¤æ™‚æ®µ ${time} å·²ç¶“æœ‰é ç´„äº†ï¼Œç¢ºå®šè¦é‡è¤‡é ç´„å—ï¼Ÿ`)) return;
  }

  // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡ç™¼é€
  const btn = document.getElementById('addApptBtn');
  btn.disabled = true;
  btn.textContent = "è™•ç†ä¸­...";

  try {
      await db.collection('appointments').add({
        memberId: phone,
        memberName: name,
        service,
        date: dayStr,
        time,
        status:'å·²é ç´„',
        note:'',
        createdAt: new Date()
      });

      closeModal();
      loadAppointments(currentYear,currentMonth);
  } catch(e) {
      alert("æ–°å¢å¤±æ•—: " + e.message);
  } finally {
      btn.disabled = false;
      btn.textContent = "ç¢ºèªæ–°å¢";
  }
});

function closeModal(){
  document.getElementById('appointmentModal').style.display='none';
  document.getElementById('modalOverlay').style.display='none';
}

function populateTimeSelect(){
  const select = document.getElementById('newTime');
  select.innerHTML='';
  // è¨­å®šç‡Ÿæ¥­æ™‚é–“ 10:00 - 20:00ï¼Œæ¯åŠå°æ™‚ä¸€å€‹å€é–“
  for(let h=10; h<=20; h++){
    const t = String(h).padStart(2,'0');
    // æ•´é»
    let opt = document.createElement('option');
    opt.value = `${t}:00`;
    opt.textContent = `${t}:00`;
    select.appendChild(opt);
    
    // åŠé» (å¦‚æœéœ€è¦)
    if(h !== 20) {
        let optHalf = document.createElement('option');
        optHalf.value = `${t}:30`;
        optHalf.textContent = `${t}:30`;
        select.appendChild(optHalf);
    }
  }
}

// --- äº‹ä»¶ç›£è½ ---
document.getElementById('modalOverlay').addEventListener('click', closeModal);

document.getElementById('prevMonth').addEventListener('click', ()=>{
  currentMonth--; if(currentMonth<0){ currentMonth=11; currentYear--; }
  loadAppointments(currentYear,currentMonth);
});
document.getElementById('nextMonth').addEventListener('click', ()=>{
  currentMonth++; if(currentMonth>11){ currentMonth=0; currentYear++; }
  loadAppointments(currentYear,currentMonth);
});
document.getElementById('refreshBtn').addEventListener('click', ()=>{
  loadAppointments(currentYear,currentMonth);
});

// æ³¨æ„ï¼šç§»é™¤äº† onSnapshot å…¨åŸŸç›£è½ï¼Œæ”¹ç‚ºæ“ä½œå¾Œä¸»å‹•åˆ·æ–°ï¼Œç¯€çœ Firebase è®€å–æ¬¡æ•¸ã€‚
</script>

</body>
</html>

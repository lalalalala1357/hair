<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>è¡Œäº‹æ›†ç®¡ç† - å¯è‰å…’ Hair Salon</title>
<style>
:root{
  --bg:#f7fff7;
  --card:#ffffff;
  --accent:#a8e6cf; /* è«è˜­è¿ªç¶  */
  --accent-dark: #7bd8a2;
  --muted:#666;
  --today-bg: #fffbf0; /* æš–é»ƒè‰²å¼·èª¿ä»Šæ—¥ */
  --danger: #ff5c5c;
  --success: #5cb85c;
  --link: #3399ff;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body{
  font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background:var(--bg);
  margin:0; padding:0; color:#333;
  padding-bottom: 20px;
}

/* --- Header & Nav --- */
header{
  background:var(--accent);
  padding:15px;
  position: sticky; top: 0; z-index: 50; /* å›ºå®šåœ¨é ‚éƒ¨ */
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
header h1{ margin:0 0 10px 0; color:#4a7c53; font-size:1.2rem; font-weight:800; }

nav {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 5px; /* é ç•™æ²å‹•æ¢ç©ºé–“ */
}
nav ul{
  list-style:none; display:flex; gap:10px; margin:0; padding:0;
}
nav a{
  text-decoration:none; color:#444; font-weight:600; font-size: 0.9rem;
  padding:8px 16px; border-radius:20px; background: rgba(255,255,255,0.4);
  white-space:nowrap; transition: all 0.2s;
}
nav a.active, nav a:hover{ background:#fff; color:#2e5c38; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

/* --- æ§åˆ¶åˆ— --- */
#controls { 
  display: flex; justify-content: center; align-items: center; gap: 10px;
  margin: 15px 0; padding: 0 10px;
}
#monthLabel { font-size: 1.1rem; font-weight: 800; min-width: 120px; text-align: center; color: #2e5c38; }
.ctrl-btn {
  background: var(--accent-dark); color: white; border: none;
  padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer;
  font-size: 0.9rem;
}
.ctrl-btn:active { transform: scale(0.95); }

/* --- RWD è¡Œäº‹æ›†ç¶²æ ¼ --- */
#calendar { 
  display:grid; 
  grid-template-columns:repeat(7,1fr); 
  gap:3px; 
  max-width:800px; 
  margin:0 auto; 
  padding: 0 5px;
}
.week-cell { 
  text-align:center; padding: 8px 0; 
  font-size: 0.85rem; color: #555; font-weight: bold;
}

.calendar-cell { 
  background:#fff; 
  border-radius: 6px;
  min-height: 85px; /* é›»è…¦ç‰ˆé«˜åº¦ */
  display: flex; flex-direction: column; align-items: center;
  border: 1px solid #eee;
  position: relative;
  cursor: pointer;
  transition: transform 0.1s;
}
.calendar-cell:active { background: #f0f0f0; }

/* ä»Šæ—¥é«˜äº® */
.calendar-cell.is-today { 
  background: var(--today-bg); border: 2px solid #ffc107; 
}
.date-num { 
  font-weight: bold; font-size: 1rem; margin-top: 5px; margin-bottom: 2px;
}

/* æ¨™ç±¤æ¨£å¼ */
.label-container { width: 100%; display: flex; flex-direction: column; gap: 2px; align-items: center; }
.label { 
  font-size: 0.75rem; color: #fff; padding: 2px 6px; 
  border-radius: 10px; width: 90%; text-align: center;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

/* --- æ‰‹æ©Ÿç‰ˆèª¿æ•´ (Media Query) --- */
@media (max-width: 768px) {
  header h1 { font-size: 1.1rem; }
  #controls { gap: 5px; }
  #monthLabel { font-size: 1rem; min-width: auto; }
  
  /* æ‰‹æ©Ÿç‰ˆæ ¼å­ç¸®å° */
  .calendar-cell { min-height: 65px; } 
  .date-num { font-size: 0.9rem; }
  
  /* æ‰‹æ©Ÿç‰ˆæ¨™ç±¤ç°¡åŒ– */
  .label { 
    font-size: 10px; padding: 1px 0; width: 90%; 
    height: 16px; line-height: 16px;
  }
}

/* --- Modal (å½ˆçª—) & Bottom Sheet --- */
#modalOverlay {
  display:none; position:fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.5); z-index:99;
  backdrop-filter: blur(3px);
  animation: fadeIn 0.2s ease;
}

#appointmentModal {
  display:none; 
  position:fixed; 
  background:#fff; 
  z-index:100; 
  box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
  display: flex; flex-direction: column;
}

/* é è¨­é›»è…¦ç‰ˆ Modal */
@media (min-width: 769px) {
  #appointmentModal {
    top:50%; left:50%; transform:translate(-50%,-50%);
    width: 450px; max-height: 85vh;
    border-radius: 12px;
    padding: 20px;
    overflow-y: auto;
  }
}

/* æ‰‹æ©Ÿç‰ˆ Bottom Sheet (é—œéµ) */
@media (max-width: 768px) {
  #appointmentModal {
    top: auto; bottom: 0; left: 0; right: 0; /* è²¼åº• */
    width: 100%; height: 85vh; /* ä½”æ“š 85% é«˜åº¦ */
    border-radius: 20px 20px 0 0; /* ä¸Šæ–¹åœ“è§’ */
    padding: 20px;
    transform: translateY(100%); /* é è¨­è—åœ¨ä¸‹é¢ */
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    display: flex !important; /* å¼·åˆ¶é¡¯ç¤ºä½†é€é transform æ§åˆ¶ */
  }
  #appointmentModal.show { transform: translateY(0); } /* æ»‘ä¸Šä¾† */
  #appointmentModal.hidden { transform: translateY(100%); display: none; } /* å®Œå…¨éš±è— */
}

/* Modal å…§å®¹ç¾åŒ– */
.modal-header { 
  display:flex; justify-content:space-between; align-items:center; 
  border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px;
}
.modal-header h3 { margin:0; font-size: 1.2rem; color: #2e5c38; }
.close-btn { 
  background:none; border:none; font-size:1.5rem; color:#999; cursor:pointer; padding:0 5px;
}

/* é ç´„åˆ—è¡¨å¡ç‰‡åŒ– */
.apptRow { 
  background: #f9f9f9; border-radius: 8px; padding: 12px; 
  margin-bottom: 10px; border-left: 4px solid #ddd;
}
.apptRow.status-done { border-left-color: var(--success); background: #f0fff4; }
.apptRow.status-cancel { border-left-color: var(--danger); opacity: 0.7; }

.apptInfo { font-size: 1rem; margin-bottom: 5px; display:flex; justify-content: space-between;}
.apptDetail { font-size: 0.9rem; color: #555; margin-bottom: 8px; }

.apptBtnGroup { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }
.apptBtnGroup button {
  padding:8px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size: 0.85rem;
}
.btn-done { background: var(--success); color:#fff; }
.btn-cancel { background: var(--danger); color:#fff; }
.btn-del { background: #e2e2e2; color:#333; }

/* æ–°å¢è¡¨å–®å„ªåŒ– */
#newApptForm {
  background: #fff; padding-top: 15px; border-top: 1px solid #eee; margin-top: auto;
}
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.form-full { grid-column: span 2; }
input, select { 
  width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; 
  background: #fff; font-size: 1rem; /* é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
}
.btn-submit { 
  width:100%; background: var(--link); color:#fff; padding: 12px; 
  border:none; border-radius: 8px; font-weight:bold; font-size: 1rem; margin-top: 10px;
}

/* å‹•ç•« */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <h1>å¯è‰å…’ Hair Salon</h1>
  <nav>
    <ul>
      <li><a href="admin-calendar.html" class="active">ğŸ“… è¡Œäº‹æ›†</a></li>
      <li><a href="vip_test.html">ğŸ‘‘ VIP</a></li>
      <li><a href="admin-news.html">ğŸ“¢ å…¬å‘Š</a></li>
      <li><a href="message.html">ğŸ’¬ ç•™è¨€</a></li>
    </ul>
  </nav>
</header>

<div id="controls">
  <button id="prevMonth" class="ctrl-btn">â—€ ä¸Šæœˆ</button>
  <span id="monthLabel"></span>
  <button id="nextMonth" class="ctrl-btn">ä¸‹æœˆ â–¶</button>
  <button id="refreshBtn" class="ctrl-btn" style="background:#3399ff;">â†»</button>
</div>

<div id="calendar"></div>

<div id="modalOverlay"></div>

<div id="appointmentModal" class="hidden">
  <div class="modal-header">
    <h3 id="modalDate">æ—¥æœŸ</h3>
    <button class="close-btn" onclick="closeModal()">Ã—</button>
  </div>
  
  <div id="modalContent" style="flex:1; overflow-y:auto; padding-bottom:10px;">
    </div>

  <div id="newApptForm">
    <h4 style="margin:0 0 10px 0; color:#444;">â• æ–°å¢é ç´„</h4>
    <div class="form-grid">
      <div class="form-full"><input type="text" id="newName" placeholder="å®¢æˆ¶å§“å"></div>
      <div class="form-full"><input type="tel" id="newPhone" placeholder="é›»è©± (09xx...)"></div>
      <div><select id="newTime"></select></div>
      <div>
        <select id="newService">
          <option value="å‰ªé«®">å‰ªé«®</option>
          <option value="æ´—é«®">æ´—é«®</option>
          <option value="ç‡™é«®">ç‡™é«®</option>
          <option value="æŸ“é«®">æŸ“é«®</option>
          <option value="è­·é«®">è­·é«®</option>
          <option value="é ­çš®è­·ç†">é ­çš®è­·ç†</option>
        </select>
      </div>
    </div>
    <button id="addApptBtn" class="btn-submit">ç¢ºèªæ–°å¢</button>
  </div>
</div>

<script>
// --- Firebase Config (ä¿æŒä¸è®Š) ---
const firebaseConfig = {
  apiKey: "AIzaSyCfxDOOzTLbmQRfvW275hJrtOnX_t-6-yc",
  authDomain: "hsinformation.firebaseapp.com",
  projectId: "hsinformation"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- è®Šæ•¸ ---
let appointments = {};
let today = new Date();
let currentYear = today.getFullYear();
let currentMonth = today.getMonth();
let selectedDay = '';
const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

// --- åˆå§‹åŒ– ---
checkAuthAndLoad();

function checkAuthAndLoad() {
    if(!localStorage.getItem('calendar_authenticated')){
        const password = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼');
        if(password === 'clear0921'){
            localStorage.setItem('calendar_authenticated','true');
            loadAppointments(currentYear, currentMonth);
        } else {
            alert('å¯†ç¢¼éŒ¯èª¤ï¼');
            document.body.innerHTML='<h2 style="text-align:center;margin-top:100px;color:red;">ğŸ”’ å­˜å–è¢«æ‹’</h2>';
        }
    } else {
        loadAppointments(currentYear, currentMonth);
    }
}

async function loadAppointments(year, month){
  document.getElementById('monthLabel').textContent = "è®€å–ä¸­...";
  const start = `${year}-${String(month+1).padStart(2,'0')}-01`;
  const end = `${year}-${String(month+1).padStart(2,'0')}-31`;
  
  try {
    const snapshot = await db.collection('appointments')
        .where('date', '>=', start).where('date', '<=', end).get();
    appointments = {};
    snapshot.forEach(doc=>{
        const data = doc.data();
        if(!appointments[data.date]) appointments[data.date]=[];
        appointments[data.date].push({...data, id: doc.id});
    });
    buildCalendar(year, month);
  } catch (error) {
    console.error(error);
    alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
  }
}

function buildCalendar(year, month){
  const calendar = document.getElementById('calendar');
  calendar.innerHTML='';
  document.getElementById('monthLabel').textContent=`${year} å¹´ ${month+1} æœˆ`;

  weekDays.forEach(d=>{
    const cell=document.createElement('div');
    cell.classList.add('week-cell');
    cell.textContent=d;
    calendar.appendChild(cell);
  });

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startWeek = firstDay.getDay(); 
  const totalDays = lastDay.getDate();
  const todayStr = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}-${String(new Date().getDate()).padStart(2,'0')}`;

  for(let i=0; i<startWeek; i++){
    const cell=document.createElement('div');
    cell.classList.add('calendar-cell');
    cell.style.background='#fcfcfc';
    cell.style.border='none'; // è®“ç©ºç™½æ ¼ä¸æ˜é¡¯
    calendar.appendChild(cell);
  }

  for(let d=1; d<=totalDays; d++){
    const dayStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cell=document.createElement('div');
    cell.classList.add('calendar-cell');
    if(dayStr === todayStr) cell.classList.add('is-today');

    const dateNum = document.createElement('div');
    dateNum.classList.add('date-num');
    dateNum.textContent = d;
    cell.appendChild(dateNum);

    const dayAppts = appointments[dayStr] || [];
    const labelContainer = document.createElement('div');
    labelContainer.classList.add('label-container');

    if(dayAppts.length > 0){
      const completedCount = dayAppts.filter(a=>a.status==='å·²å®Œæˆ').length;
      const pendingCount = dayAppts.filter(a=>a.status==='å·²é ç´„').length;

      if(pendingCount>0){
        const label = document.createElement('div');
        label.classList.add('label');
        label.style.background='#ff5c5c';
        label.textContent = `${pendingCount} é ç´„`;
        labelContainer.appendChild(label);
      }
      if(completedCount>0){
        const label = document.createElement('div');
        label.classList.add('label');
        label.style.background='#5cb85c';
        label.textContent = `${completedCount} å®Œæˆ`;
        labelContainer.appendChild(label);
      }
    }
    cell.appendChild(labelContainer);
    cell.addEventListener('click', ()=>manageDay(dayStr));
    calendar.appendChild(cell);
  }
}

// --- äº’å‹•é‚è¼¯ (Modal/Bottom Sheet) ---
function manageDay(dayStr){
  selectedDay = dayStr;
  let dayAppointments = appointments[dayStr] || [];
  dayAppointments.sort((a, b) => a.time.localeCompare(b.time));

  const modal = document.getElementById('appointmentModal');
  const overlay = document.getElementById('modalOverlay');
  const content = document.getElementById('modalContent');
  const modalDate = document.getElementById('modalDate');
  const dateObj = new Date(dayStr);
  
  modalDate.textContent = `ğŸ“… ${dayStr} (${weekDays[dateObj.getDay()]})`;
  content.innerHTML='';

  if(dayAppointments.length === 0) {
      content.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ğŸ“­ å°šç„¡é ç´„</div>';
  }

  dayAppointments.forEach((a,i)=>{
    const row = document.createElement('div');
    row.classList.add('apptRow');
    if(a.status==='å·²å®Œæˆ') row.classList.add('status-done');
    if(a.status==='å·²å–æ¶ˆ') row.classList.add('status-cancel');

    row.innerHTML = `
      <div class="apptInfo">
        <span><b>${a.time}</b> ${a.memberName}</span>
        <span style="font-size:0.8rem;background:#eee;padding:2px 5px;border-radius:4px;">${a.status}</span>
      </div>
      <div class="apptDetail">é …ç›®: ${a.service} | é›»è©±: ${a.memberId}</div>
    `;

    const btnGroup = document.createElement('div');
    btnGroup.classList.add('apptBtnGroup');

    if(a.status !== 'å·²å®Œæˆ' && a.status !== 'å·²å–æ¶ˆ') {
        const btnDone = document.createElement('button');
        btnDone.textContent='âœ… å®Œæˆ';
        btnDone.className = 'btn-done';
        btnDone.onclick = ()=>updateAppointmentStatus(a.id,'å·²å®Œæˆ');
        btnGroup.appendChild(btnDone);

        const btnCancel = document.createElement('button');
        btnCancel.textContent='ğŸš« å–æ¶ˆ';
        btnCancel.className = 'btn-cancel';
        btnCancel.onclick = ()=>updateAppointmentStatus(a.id,'å·²å–æ¶ˆ');
        btnGroup.appendChild(btnCancel);
    }
    
    // å³ä½¿å®Œæˆæˆ–å–æ¶ˆï¼Œä»ä¿ç•™åˆªé™¤æŒ‰éˆ•
    const btnDelete = document.createElement('button');
    btnDelete.textContent='ğŸ—‘ åˆªé™¤';
    btnDelete.className = 'btn-del';
    btnDelete.onclick = ()=>deleteAppointment(dayStr, i);
    btnGroup.appendChild(btnDelete);

    row.appendChild(btnGroup);
    content.appendChild(row);
  });

  populateTimeSelect();
  document.getElementById('newName').value='';
  document.getElementById('newPhone').value='';
  
  // é¡¯ç¤º Modal (è™•ç†å‹•ç•«)
  overlay.style.display='block';
  modal.style.display='flex'; 
  // å°å»¶é²è®“ CSS transition ç”Ÿæ•ˆ
  setTimeout(()=> {
    modal.classList.remove('hidden');
    modal.classList.add('show');
  }, 10);
}

function closeModal(){
  const modal = document.getElementById('appointmentModal');
  const overlay = document.getElementById('modalOverlay');
  
  // æ”¶èµ·å‹•ç•«
  modal.classList.remove('show');
  modal.classList.add('hidden'); // ç§»åˆ°ä¸‹æ–¹
  
  setTimeout(()=>{
      overlay.style.display='none';
      // æ³¨æ„ï¼šæ‰‹æ©Ÿç‰ˆä¸éš±è— displayï¼Œåªç”¨ transformï¼›ä½†ç‚ºäº†å…¼å®¹é›»è…¦ç‰ˆï¼Œé€™è£¡å¯ä»¥ä¿ç•™ display é‚è¼¯
      if(window.innerWidth > 768) modal.style.display='none'; 
  }, 300); // ç­‰å¾…å‹•ç•«çµæŸ
}

// --- CRUD é‚è¼¯ (ä¿æŒèˆ‡ä¹‹å‰ç›¸åŒ) ---
async function updateAppointmentStatus(apptId, newStatus){
  await db.collection('appointments').doc(apptId).update({ status: newStatus });
  closeModal();
  loadAppointments(currentYear,currentMonth);
}

async function deleteAppointment(dayStr, index){
  if(!confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ï¼Ÿ")) return;
  const appt = appointments[dayStr][index];
  await db.collection('appointments').doc(appt.id).delete();
  closeModal();
  loadAppointments(currentYear,currentMonth);
}

document.getElementById('addApptBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('newName').value.trim();
  const phone = document.getElementById('newPhone').value.trim();
  const time = document.getElementById('newTime').value;
  const service = document.getElementById('newService').value;
  
  if(!name||!phone){ alert('è«‹å¡«å¯«å§“åèˆ‡é›»è©±'); return; }

  const btn = document.getElementById('addApptBtn');
  btn.disabled = true; btn.textContent = "è™•ç†ä¸­...";

  try {
      await db.collection('appointments').add({
        memberId: phone, memberName: name, service, date: selectedDay, time,
        status:'å·²é ç´„', createdAt: new Date()
      });
      closeModal();
      loadAppointments(currentYear,currentMonth);
  } catch(e) { alert("éŒ¯èª¤: "+e.message); } 
  finally { btn.disabled = false; btn.textContent = "ç¢ºèªæ–°å¢"; }
});

function populateTimeSelect(){
  const select = document.getElementById('newTime');
  select.innerHTML='';
  for(let h=10; h<=20; h++){
    const t = String(h).padStart(2,'0');
    select.appendChild(new Option(`${t}:00`, `${t}:00`));
    if(h!==20) select.appendChild(new Option(`${t}:30`, `${t}:30`));
  }
}

document.getElementById('modalOverlay').addEventListener('click', closeModal);
document.getElementById('prevMonth').addEventListener('click', ()=>{
  currentMonth--; if(currentMonth<0){ currentMonth=11; currentYear--; }
  loadAppointments(currentYear,currentMonth);
});
document.getElementById('nextMonth').addEventListener('click', ()=>{
  currentMonth++; if(currentMonth>11){ currentMonth=0; currentYear++; }
  loadAppointments(currentYear,currentMonth);
});
document.getElementById('refreshBtn').addEventListener('click', ()=>{
  loadAppointments(currentYear,currentMonth);
});
</script>
</body>
</html>

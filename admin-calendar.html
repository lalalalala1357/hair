<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è¡Œäº‹æ›†ç®¡ç† - å¯è‰å…’ Hair Salon</title>
<style>
:root{
  --bg:#f7fff7;
  --card:#ffffff;
  --accent:#a8e6cf;
  --muted:#666;
  --btn:#ccc;
}
body{font-family:Arial, Helvetica, sans-serif;background:var(--bg);margin:0;padding:0;color:#333}

/* header/nav */
header{background:#a8e6cf;padding:15px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;}
header h1{margin:0;color:#4a7c53;font-weight:bold;font-size:18px;}

nav {
  overflow-x: auto;           /* è¶…å‡ºå¯¬åº¦æ™‚æ°´å¹³æ»‘å‹• */
  overflow-y: hidden;         /* ç¦æ­¢ä¸Šä¸‹æ»¾å‹• */
  -webkit-overflow-scrolling: touch; /* æ‰‹æ©Ÿæ»‘å‹•é †æš¢ */
}

nav ul{
  list-style:none;
  display:flex;gap:12px;
  margin:0;
  padding:0;
  white-space:nowrap;

}
nav a{
  text-decoration:none;
  color:#333;
  font-weight:bold;
  padding:6px 12px;
  border-radius:4px;
  flex-shrink: 0;             /* é˜²æ­¢è‡ªå‹•å£“ç¸® */

}
nav a:hover, nav a.active{background:#7bd8a2;color:#fff;}

/* è¡Œäº‹æ›† */
#controls { 
  text-align:center; 
  margin:20px 0; 
}
#calendar { 
  display:grid; 
  grid-template-columns:repeat(7,1fr); 
  gap:2px; 
  max-width:700px; 
  margin:0 auto; 
}
.week-cell, .calendar-cell { 
  padding:10px; 
  border:1px solid #ccc; 
  text-align:center; 
}
.week-cell { 
  background:#e0f2e9; 
  font-weight:bold; 
}
.calendar-cell { 
  background:#fff; 
  cursor:pointer; 
  position:relative; 
}
.calendar-cell:hover { 
  background:#7bd8a2; 
  color:#000; 
}
.label { 
  position:absolute; 
  right:4px; 
  color:#fff; 
  font-size:0.7rem; 
  padding:2px 4px; 
  border-radius:3px; 
}
button { 
  margin:5px 5px 0 0; 
  padding:6px 12px; 
  background:#7bd8a2; 
  border:none; 
  color:#fff; 
  border-radius:4px; 
  cursor:pointer; 
}
button:hover { 
  background:#5bb174; 
}

/* Modal */
#appointmentModal {
  display:none; 
  position:fixed; 
  top:50%; 
  left:50%; 
  transform:translate(-50%,-50%);
  background:#fff; 
  border:1px solid #ccc; 
  padding:20px; 
  border-radius:8px; 
  max-width:420px; 
  z-index:100; 
  max-height:80vh; 
  overflow-y:auto;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
}
#appointmentModal h3 { margin-top:0; }
.apptRow { border-bottom:1px solid #ddd; padding:8px 0; display:flex; flex-direction:column; gap:4px; }
.apptRow span { display:block; }
.apptBtnGroup { display:flex; gap:5px; margin-top:4px; }
.apptRow button { padding:6px 10px; border:none; border-radius:5px; font-weight:bold; cursor:pointer; transition: background 0.2s; }
.apptDone { background:#5cb85c; color:#fff; }
.apptDone:hover { background:#4cae4c; }
.apptCancel { background:#ff5c5c; color:#fff; }
.apptCancel:hover { background:#e04e4e; }
.apptDelete { background:#ccc; color:#333; }
.apptDelete:hover { background:#aaa; }

#modalOverlay {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.3);
  z-index:99;
}

/* æ–°å¢é ç´„è¡¨å–® */
#newApptForm {
  margin-top:15px;
  display: flex;
  flex-direction: column;
  gap:12px;
}
#newApptForm label {
  display: flex;
  flex-direction: column;
  font-weight: bold;
  font-size: 0.9rem;
  color: #333;
}
#newApptForm input, #newApptForm select {
  padding: 8px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  transition: border 0.2s, box-shadow 0.2s;
}
#newApptForm input:focus, #newApptForm select:focus {
  outline: none;
  border-color: #7bd8a2;
  box-shadow: 0 0 5px rgba(123,216,162,0.5);
}
#addApptBtn {
  background: #3399ff;
  color: #fff;
  font-weight:bold;
  border-radius:6px;
  cursor:pointer;
  transition: background 0.2s;
}
#addApptBtn:hover { background: #287acc; }
#newApptForm button:last-child {
  background: #ccc;
  color: #333;
}
#newApptForm button:last-child:hover { background: #aaa; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <h1>å¯è‰å…’ Hair Salon - ç®¡ç†å¾Œå°</h1>
  <nav>
    <ul>
      <li><a href="admin-calendar.html" class="active">è¡Œäº‹æ›†ç®¡ç†</a></li>
      <li><a href="vip_test.html">VIPç®¡ç†</a></li>
      <li><a href="admin-news.html">å…¬å‘Šç®¡ç†</a></li>
      <li><a href="message.html" class=>ç•™è¨€ç®¡ç†</a></li>
    </ul>
  </nav>
</header>

<div id="controls">
  <button id="prevMonth">ä¸Šå€‹æœˆ</button>
  <span id="monthLabel" style="font-weight:bold; margin:0 15px;"></span>
  <button id="nextMonth">ä¸‹å€‹æœˆ</button>
  <button id="refreshBtn">é‡æ–°æ•´ç†</button>
</div>

<div id="calendar"></div>

<div id="modalOverlay"></div>

<div id="appointmentModal">
  <h3 id="modalDate"></h3>
  <div id="modalContent"></div>

  <hr>
  <h4>æ–°å¢é ç´„</h4>
  <div id="newApptForm">
    <label>å§“å:<input type="text" id="newName"></label>
    <label>é›»è©±:<input type="text" id="newPhone"></label>
    <label>æ™‚é–“:<select id="newTime"></select></label>
    <label>æœå‹™:
      <select id="newService">
        <option value="å‰ªé«®">å‰ªé«®</option>
        <option value="æ´—é«®">æ´—é«®</option>
        <option value="ç‡™é«®">ç‡™é«®</option>
        <option value="æŸ“é«®">æŸ“é«®</option>
      </select>
    </label>
    <button id="addApptBtn">æ–°å¢</button>
    <button onclick="closeModal()">å–æ¶ˆ</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCfxDOOzTLbmQRfvW275hJrtOnX_t-6-yc",
  authDomain: "hsinformation.firebaseapp.com",
  projectId: "hsinformation"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let appointments = {};
let today = new Date();
let currentYear = today.getFullYear();
let currentMonth = today.getMonth();
let selectedDay = '';
const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

async function loadAppointments(year, month){
  const start = `${year}-${String(month+1).padStart(2,'0')}-01`;
  const end = `${year}-${String(month+1).padStart(2,'0')}-31`;
  const snapshot = await db.collection('appointments')
    .where('date', '>=', start)
    .where('date', '<=', end)
    .get();

  appointments = {};
  snapshot.forEach(doc=>{
    const data = doc.data();
    if(!appointments[data.date]) appointments[data.date]=[];
    appointments[data.date].push({...data, id: doc.id});
  });

  buildCalendar(year, month);
}

function buildCalendar(year, month){
  const calendar = document.getElementById('calendar');
  calendar.innerHTML='';
  document.getElementById('monthLabel').textContent=`${year} å¹´ ${month+1} æœˆ`;

  weekDays.forEach(d=>{
    const cell=document.createElement('div');
    cell.classList.add('week-cell');
    cell.textContent=d;
    calendar.appendChild(cell);
  });

  const firstDay=new Date(year,month,1);
  const lastDay=new Date(year,month+1,0);
  const startWeek=firstDay.getDay();
  const totalDays=lastDay.getDate();

  for(let i=0;i<startWeek;i++){
    const cell=document.createElement('div');
    cell.classList.add('calendar-cell');
    cell.style.background='#f0f0f0';
    calendar.appendChild(cell);
  }

  for(let d=1; d<=totalDays; d++){
    const dayStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cell=document.createElement('div');
    cell.classList.add('calendar-cell');
    cell.textContent=d;

    const dayAppts = appointments[dayStr] || [];
    if(dayAppts.length > 0){
      const completedCount = dayAppts.filter(a=>a.status==='å·²å®Œæˆ').length;
      const pendingCount = dayAppts.filter(a=>a.status==='å·²é ç´„').length;

      let offset = 4;
      if(pendingCount>0){
        const label = document.createElement('div');
        label.classList.add('label');
        label.style.background='#ff5c5c';
        label.style.top = offset + 'px';
        label.textContent = pendingCount;
        cell.appendChild(label);
        offset += 18;
      }
      if(completedCount>0){
        const label = document.createElement('div');
        label.classList.add('label');
        label.style.background='#5cb85c';
        label.style.top = offset + 'px';
        label.textContent = completedCount;
        cell.appendChild(label);
      }
    }

    cell.addEventListener('click', ()=>manageDay(dayStr));
    calendar.appendChild(cell);
  }
}

async function updateAppointmentStatus(apptId, newStatus){
  await db.collection('appointments').doc(apptId).update({ status: newStatus });
  closeModal();
  loadAppointments(currentYear,currentMonth);
}

async function deleteAppointment(dayStr, index){
  const appt = appointments[dayStr][index];
  await db.collection('appointments').doc(appt.id).delete();
  appointments[dayStr].splice(index,1);
  if(appointments[dayStr].length===0) delete appointments[dayStr];
  closeModal();
  loadAppointments(currentYear,currentMonth);
}

function manageDay(dayStr){
  selectedDay = dayStr;
  const dayAppointments = appointments[dayStr] || [];
  const modal = document.getElementById('appointmentModal');
  const overlay = document.getElementById('modalOverlay');
  const content = document.getElementById('modalContent');
  const modalDate = document.getElementById('modalDate');
  modalDate.textContent = `ğŸ“… ${dayStr} çš„é ç´„`;
  content.innerHTML='';

  dayAppointments.forEach((a,i)=>{
    const row = document.createElement('div');
    row.classList.add('apptRow');
    row.innerHTML = `
      <span>${a.time} - ${a.memberName} (${a.memberId})</span>
      <span>æœå‹™: ${a.service}</span>
      <span>ç‹€æ…‹: ${a.status}</span>
    `;

    const btnGroup = document.createElement('div');
    btnGroup.classList.add('apptBtnGroup');

    const btnDone = document.createElement('button');
    btnDone.textContent='å®Œæˆ';
    btnDone.classList.add('apptDone');
    btnDone.onclick = ()=>updateAppointmentStatus(a.id,'å·²å®Œæˆ');

    const btnCancel = document.createElement('button');
    btnCancel.textContent='å–æ¶ˆé ç´„';
    btnCancel.classList.add('apptCancel');
    btnCancel.onclick = ()=>updateAppointmentStatus(a.id,'å·²å–æ¶ˆ');

    const btnDelete = document.createElement('button');
    btnDelete.textContent='åˆªé™¤';
    btnDelete.classList.add('apptDelete');
    btnDelete.onclick = ()=>deleteAppointment(dayStr,i);

    btnGroup.appendChild(btnDone);
    btnGroup.appendChild(btnCancel);
    btnGroup.appendChild(btnDelete);

    row.appendChild(btnGroup);
    content.appendChild(row);
  });

  populateTimeSelect();
  document.getElementById('newName').value='';
  document.getElementById('newPhone').value='';
  document.getElementById('newService').selectedIndex=0;
  document.getElementById('newTime').selectedIndex=0;

  overlay.style.display='block';
  modal.style.display='block';
}

function closeModal(){
  document.getElementById('appointmentModal').style.display='none';
  document.getElementById('modalOverlay').style.display='none';
}

function populateTimeSelect(){
  const select = document.getElementById('newTime');
  select.innerHTML='';
  for(let h=9; h<=20; h++){
    const t = String(h).padStart(2,'0') + ':00';
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    select.appendChild(opt);
  }
}

document.getElementById('addApptBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('newName').value.trim();
  const phone = document.getElementById('newPhone').value.trim();
  const time = document.getElementById('newTime').value;
  const service = document.getElementById('newService').value;
  if(!name||!phone||!time||!service){ alert('è«‹å¡«å¯«å®Œæ•´'); return; }

  const dayStr = selectedDay;
  const conflict = (appointments[dayStr]||[]).some(a=>a.time===time);
  if(conflict){ alert('æ­¤æ™‚æ®µå·²è¢«é ç´„'); return; }

  const docRef2 = await db.collection('appointments').add({
    memberId: phone,
    memberName: name,
    service,
    date: dayStr,
    time,
    status:'å·²é ç´„',
    note:'',
    createdAt: new Date()
  });

  if(!appointments[dayStr]) appointments[dayStr]=[];
  appointments[dayStr].push({id: docRef2.id, memberId: phone, memberName:name, service, date:dayStr, time, status:'å·²é ç´„'});

  document.getElementById('newName').value='';
  document.getElementById('newPhone').value='';
  document.getElementById('newService').selectedIndex=0;
  document.getElementById('newTime').selectedIndex=0;

  closeModal();
  loadAppointments(currentYear,currentMonth);
});

document.getElementById('modalOverlay').addEventListener('click', closeModal);

document.getElementById('prevMonth').addEventListener('click', ()=>{
  currentMonth--; if(currentMonth<0){ currentMonth=11; currentYear--; }
  loadAppointments(currentYear,currentMonth);
});
document.getElementById('nextMonth').addEventListener('click', ()=>{
  currentMonth++; if(currentMonth>11){ currentMonth=0; currentYear++; }
  loadAppointments(currentYear,currentMonth);
});
document.getElementById('refreshBtn').addEventListener('click', ()=>{
  loadAppointments(currentYear,currentMonth);
});

if(!localStorage.getItem('calendar_authenticated')){
  const password = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼');
  if(password==='clear0921'){
    localStorage.setItem('calendar_authenticated','true');
    loadAppointments(currentYear,currentMonth);
  } else {
    alert('å¯†ç¢¼éŒ¯èª¤ï¼');
    document.body.innerHTML='<h2 style="text-align:center;margin-top:100px;">å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•é€²å…¥è¡Œäº‹æ›†</h2>';
  }
} else {
  loadAppointments(currentYear,currentMonth);
}

db.collection('appointments').onSnapshot(()=>{
  loadAppointments(currentYear,currentMonth);
});
</script>

</body>
</html>

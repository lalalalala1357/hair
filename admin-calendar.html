<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è¡Œäº‹æ›†ç®¡ç† - å¯è‰å…’ Hair Salon</title>
<style>
  :root{
    --bg:#f7fff7;
    --accent:#a8e6cf;
    --muted:#666;
  }
  body{
    font-family: Arial, Helvetica, sans-serif;
    background: var(--bg);
    margin:0;
    padding:0;
  }
  header{
    background:#a8e6cf;
    padding:15px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  header h1{
    margin:0;
    color:#4a7c53;
    font-weight:bold;
    font-size:18px;
  }
  nav ul{
    list-style:none;
    display:flex;
    gap:12px;
    margin:0;
    padding:0;
  }
  nav a{
    text-decoration:none;
    color:#333;
    font-weight:bold;
    padding:6px 12px;
    border-radius:4px;
  }
  nav a:hover, nav a.active{
    background:#7bd8a2;
    color:#fff;
  }

  #controls { 
    text-align:center; 
    margin:20px 0; 
  }
  #calendar { 
    display:grid; 
    grid-template-columns:repeat(7,1fr); 
    gap:2px; 
    max-width:700px; 
    margin:0 auto; 
  }
  .week-cell, .calendar-cell { 
    padding:10px; 
    border:1px solid #ccc; 
    text-align:center; 
  }
  .week-cell { 
    background:#e0f2e9; 
    font-weight:bold; 
  }
  .calendar-cell { 
    background:#fff; 
    cursor:pointer; 
    position:relative; 
  }
  .calendar-cell:hover { 
    background:#7bd8a2; 
    color:#000; /* æ”¹æˆé»‘è‰²ï¼Œé¿å…ç™½å­—çœ‹ä¸åˆ° */
  }
  .label { 
    position:absolute; 
    top:4px; 
    right:4px; 
    background:#ff5c5c; 
    color:#fff; 
    font-size:0.7rem; 
    padding:2px 4px; 
    border-radius:3px; 
  }
  button { 
    margin:0 5px; 
    padding:6px 12px; 
    background:#7bd8a2; 
    border:none; 
    color:#fff; 
    border-radius:4px; 
    cursor:pointer; 
  }
  button:hover { 
    background:#5bb174; 
  }
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <h1>å¯è‰å…’ Hair Salon</h1>
  <nav>
    <ul>
      <li><a href="vip_test.html">VIP ç®¡ç†</a></li>
      <li><a href="admin-calendar.html" class="active">è¡Œäº‹æ›†ç®¡ç†</a></li>
    </ul>
  </nav>
</header>

<div id="controls">
  <button id="prevMonth">ä¸Šå€‹æœˆ</button>
  <span id="monthLabel" style="font-weight:bold; margin:0 15px;"></span>
  <button id="nextMonth">ä¸‹å€‹æœˆ</button>
  <button id="refreshBtn">é‡æ–°æ•´ç†</button>
</div>

<div id="calendar"></div>

<script>
  // ---------------- Firebase åˆå§‹åŒ– ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyAXbCW5UXRp085kJc9DjE5z2rbDJNFv47g",
    authDomain: "hair-salon-56eb5.firebaseapp.com",
    projectId: "hair-salon-56eb5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ---------------- å…¨åŸŸè®Šæ•¸ ----------------
  let appointments = {};
  let members = {};
  let today = new Date();
  let currentYear = today.getFullYear();
  let currentMonth = today.getMonth();
  const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

  // ---------------- è¼‰å…¥æœƒå“¡è³‡æ–™ ----------------
  async function loadMembers(){
    const snapshot = await db.collection('members').get();
    members = {};
    snapshot.forEach(doc=>{
      const data = doc.data();
      members[data.phone] = data;
    });
  }

  // ---------------- è¼‰å…¥ç•¶æœˆé ç´„ ----------------
  async function loadAppointments(year, month){
    await loadMembers();
    const start = `${year}-${String(month+1).padStart(2,'0')}-01`;
    const end = `${year}-${String(month+1).padStart(2,'0')}-31`;
    const snapshot = await db.collection('appointments')
      .where('date', '>=', start)
      .where('date', '<=', end)
      .get();

    appointments = {};
    snapshot.forEach(doc=>{
      const data = doc.data();
      if(!appointments[data.date]) appointments[data.date]=[];
      appointments[data.date].push({...data, id: doc.id});
    });

    buildCalendar(year, month);
  }

  // ---------------- å»ºç«‹æ—¥æ›† ----------------
  function buildCalendar(year, month){
    const calendar = document.getElementById('calendar');
    calendar.innerHTML='';
    document.getElementById('monthLabel').textContent=`${year} å¹´ ${month+1} æœˆ`;

    weekDays.forEach(d=>{
      const cell=document.createElement('div');
      cell.classList.add('week-cell');
      cell.textContent=d;
      calendar.appendChild(cell);
    });

    const firstDay=new Date(year,month,1);
    const lastDay=new Date(year,month+1,0);
    const startWeek=firstDay.getDay();
    const totalDays=lastDay.getDate();

    for(let i=0;i<startWeek;i++){
      const cell=document.createElement('div');
      cell.classList.add('calendar-cell');
      cell.style.background='#f0f0f0';
      calendar.appendChild(cell);
    }

    for(let d=1; d<=totalDays; d++){
      const dayStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const cell=document.createElement('div');
      cell.classList.add('calendar-cell');
      cell.textContent=d;

      if(appointments[dayStr] && appointments[dayStr].length>0){
        const label = document.createElement('div');
        label.classList.add('label');
        let count = appointments[dayStr].length;
        const hasVIP = appointments[dayStr].some(a => members[a.memberId] && members[a.memberId].balance>0);
        label.textContent = hasVIP ? `â˜…${count}` : `${count}`;
        cell.appendChild(label);
      }

      cell.addEventListener('click', ()=>manageDay(dayStr));
      calendar.appendChild(cell);
    }
  }

  // ---------------- æ–°å¢é ç´„ ----------------
  async function addAppointment(dayStr, name, phone, service, time){
    const conflict = (appointments[dayStr]||[]).some(a=>a.time===time);
    if(conflict){ alert('æ­¤æ™‚æ®µå·²è¢«é ç´„ï¼'); return; }

    if(!members[phone]){
      const docRef = await db.collection('members').add({
        phone,
        name,
        balance: 0,
        note: '',
        joinedAt: new Date()
      });
      members[phone] = {phone,name,balance:0,note:'',joinedAt:new Date()};
    }

    const docRef2 = await db.collection('appointments').add({
      memberId: phone,
      memberName: name,
      service,
      date: dayStr,
      time,
      status: 'å·²é ç´„',
      note: '',
      createdAt: new Date()
    });

    if(!appointments[dayStr]) appointments[dayStr]=[];
    appointments[dayStr].push({id: docRef2.id, memberId: phone, memberName:name, service, date:dayStr, time, status:'å·²é ç´„'});
    buildCalendar(currentYear,currentMonth);
  }

  // ---------------- åˆªé™¤é ç´„ ----------------
  async function deleteAppointment(dayStr, index){
    const appt = appointments[dayStr][index];
    await db.collection('appointments').doc(appt.id).delete();
    appointments[dayStr].splice(index,1);
    if(appointments[dayStr].length===0) delete appointments[dayStr];
    buildCalendar(currentYear,currentMonth);
  }

  // ---------------- ç®¡ç†æ ¼å­ ----------------
  function manageDay(dayStr){
    const dayAppointments = appointments[dayStr] || [];
    let msg = `ğŸ“… ${dayStr} çš„é ç´„:\n\n`;
    dayAppointments.forEach((a,i)=>{
      let star = members[a.memberId] && members[a.memberId].balance>0 ? ' â˜…VIP' : '';
      msg+=`${i+1}. ${a.time} - ${a.memberName} (${a.memberId})${star}\n æœå‹™: ${a.service}\n`;
    });
    msg+='\nè¼¸å…¥:\n1 = æ–°å¢é ç´„\n2 = åˆªé™¤é ç´„\nå–æ¶ˆ = é›¢é–‹';
    const action = prompt(msg);
    if(action==='1'){
      const name=prompt('å§“å:'); if(!name) return;
      const phone=prompt('é›»è©±:'); if(!phone) return;
      const service=prompt('æœå‹™é …ç›®:'); if(!service) return;
      const time=prompt('æ™‚é–“ (ä¾‹å¦‚ 10:00):'); if(!time) return;
      addAppointment(dayStr,name,phone,service,time);
    } else if(action==='2'){
      if(dayAppointments.length===0){ alert('ç„¡é ç´„å¯åˆª'); return; }
      let delMsg='è¼¸å…¥è¦åˆªé™¤çš„ç·¨è™Ÿ:\n';
      dayAppointments.forEach((a,i)=>{
        delMsg+=`${i+1}. ${a.time} - ${a.memberName} (${a.memberId})\n`;
      });
      const delIndex=parseInt(prompt(delMsg))-1;
      if(!isNaN(delIndex) && dayAppointments[delIndex]){
        deleteAppointment(dayStr,delIndex);
      }
    }
  }

  // ---------------- ä¸Šä¸‹æœˆ ----------------
  document.getElementById('prevMonth').addEventListener('click', ()=>{
    currentMonth--; if(currentMonth<0){ currentMonth=11; currentYear--; }
    loadAppointments(currentYear,currentMonth);
  });
  document.getElementById('nextMonth').addEventListener('click', ()=>{
    currentMonth++; if(currentMonth>11){ currentMonth=0; currentYear++; }
    loadAppointments(currentYear,currentMonth);
  });

  // ---------------- é‡æ–°æ•´ç† ----------------
  document.getElementById('refreshBtn').addEventListener('click', ()=>{
    loadAppointments(currentYear,currentMonth);
  });

  // ---------------- åˆå§‹è¼‰å…¥ ----------------
  if(!localStorage.getItem('calendar_authenticated')){
    const password = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼');
    if(password==='salon2025'){
      localStorage.setItem('calendar_authenticated','true');
      loadAppointments(currentYear,currentMonth);
    } else {
      alert('å¯†ç¢¼éŒ¯èª¤ï¼');
      document.body.innerHTML='<h2 style="text-align:center;margin-top:100px;">å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•é€²å…¥è¡Œäº‹æ›†</h2>';
    }
  } else {
    loadAppointments(currentYear,currentMonth);
  }

  // ---------------- å³æ™‚ç›£è½ ----------------
  db.collection('appointments').onSnapshot(()=>{
    loadAppointments(currentYear,currentMonth);
  });
</script>

</body>
</html>

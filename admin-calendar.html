<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>行事曆管理 - 可莉兒 Hair Salon</title>
<style>
body { font-family: Arial, sans-serif; background:#f9fff9; margin:0; padding:0; }
header { background:#a8e6cf; padding:20px; text-align:center; color:#4a7c53; font-weight:bold; }
nav ul { list-style:none; display:flex; gap:15px; justify-content:center; margin:15px 0 0 0; padding:0; }
nav a { text-decoration:none; color:#333; font-weight:bold; padding:6px 10px; border-radius:4px; }
nav a:hover, nav a.active { background:#7bd8a2; color:#fff; }
#controls { text-align:center; margin:20px 0; }
#calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; max-width:700px; margin:0 auto; }
.week-cell, .calendar-cell { padding:10px; border:1px solid #ccc; text-align:center; }
.week-cell { background:#e0f2e9; font-weight:bold; }
.calendar-cell { background:#fff; cursor:pointer; position:relative; }
.calendar-cell:hover { background:#7bd8a2; color:#fff; }
.label { position:absolute; top:4px; right:4px; background:#ff5c5c; color:#fff; font-size:0.7rem; padding:2px 4px; border-radius:3px; }
button { margin:0 5px; padding:6px 12px; background:#7bd8a2; border:none; color:#fff; border-radius:4px; cursor:pointer; }
button:hover { background:#5bb174; }
</style>
</head>
<body>

<header>
可莉兒 Hair Salon - 行事曆管理
<nav>
<ul>
<li><a href="vip.html">VIP 管理</a></li>
<li><a href="admin-calendar.html" class="active">行事曆管理</a></li>
</ul>
</nav>
</header>

<div id="controls">
<button id="prevMonth">上個月</button>
<span id="monthLabel" style="font-weight:bold; margin:0 15px;"></span>
<button id="nextMonth">下個月</button>
<button id="refreshBtn">重新整理</button>
</div>

<div id="calendar"></div>

<script>
let appointments = {}; // 從 API 抓取
let today = new Date();
let currentYear = today.getFullYear();
let currentMonth = today.getMonth();
const weekDays = ['日','一','二','三','四','五','六'];

// 讀取所有預約
async function fetchAppointments(){
  try{
    const res = await fetch('/.netlify/functions/get-appointments');
    appointments = await res.json();
  }catch(err){
    alert('無法讀取預約資料');
    console.error(err);
    appointments = {};
  }
}

// 建立行事曆
function buildCalendar(){
  const calendar = document.getElementById('calendar');
  calendar.innerHTML='';
  document.getElementById('monthLabel').textContent=`${currentYear} 年 ${currentMonth+1} 月`;

  // 星期標題
  weekDays.forEach(d=>{
    const cell=document.createElement('div');
    cell.classList.add('week-cell');
    cell.textContent=d;
    calendar.appendChild(cell);
  });

  const firstDay=new Date(currentYear,currentMonth,1);
  const lastDay=new Date(currentYear,currentMonth+1,0);
  const startWeek=firstDay.getDay();
  const totalDays=lastDay.getDate();

  // 空白格補齊
  for(let i=0;i<startWeek;i++){
    const cell=document.createElement('div');
    cell.classList.add('calendar-cell');
    cell.style.background='#f0f0f0';
    calendar.appendChild(cell);
  }

  // 每天格子
  for(let d=1; d<=totalDays; d++){
    const dayStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cell=document.createElement('div');
    cell.classList.add('calendar-cell');
    cell.textContent=d;

    // 顯示預約數量
    if(appointments[dayStr] && appointments[dayStr].length>0){
      const label = document.createElement('div');
      label.classList.add('label');
      label.textContent = appointments[dayStr].length;
      cell.appendChild(label);
    }

    cell.addEventListener('click', ()=>manageDay(dayStr));
    calendar.appendChild(cell);
  }
}

// 點選每天管理
async function manageDay(dayStr){
  const dayAppointments = appointments[dayStr] || [];
  let msg = `📅 ${dayStr} 的預約:\n\n`;
  dayAppointments.forEach((a,i)=>{
    msg+=`${i+1}. ${a.time} - ${a.name} (${a.phone})\n 服務: ${a.service}\n`;
  });
  msg+='\n輸入:\n1 = 新增預約\n取消 = 離開';
  const action = prompt(msg);
  if(action==='1'){
    const name=prompt('姓名:'); if(!name) return;
    const phone=prompt('電話:'); if(!phone) return;
    const service=prompt('服務項目:'); if(!service) return;
    const time=prompt('時間 (例如 10:00):'); if(!time) return;

    try{
      const res = await fetch('/.netlify/functions/add-appointment',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({day:dayStr,name,phone,service,time})
      });
      if(res.ok){
        await fetchAppointments();
        buildCalendar();
        alert('✅ 新增成功！');
      }else{
        alert('新增失敗');
      }
    }catch(err){
      alert('新增失敗');
      console.error(err);
    }
  }
}

// 月份切換
document.getElementById('prevMonth').addEventListener('click', ()=>{
  currentMonth--; if(currentMonth<0){ currentMonth=11; currentYear--; }
  buildCalendar();
});
document.getElementById('nextMonth').addEventListener('click', ()=>{
  currentMonth++; if(currentMonth>11){ currentMonth=0; currentYear++; }
  buildCalendar();
});
document.getElementById('refreshBtn').addEventListener('click', async ()=>{
  await fetchAppointments();
  buildCalendar();
});

// 初始化
(async ()=>{
  await fetchAppointments();
  buildCalendar();
})();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>é ç´„ - å¯è‰å…’ Hair Salon</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9fff9;
    color: #333;
    margin: 0;
    padding: 0;
  }

  header {
    position: fixed;
    top: 0; left: 0; width: 100%;
    background-color: #a8e6cf;
    padding: 20px;
    z-index: 1000;
  }
  header h2 {
    margin: 0;
    color: #4a7c53;
  }

  nav ul {
    list-style: none;
    display: flex;
    gap: 15px;
    padding: 10px 0 0 0;
    margin: 0;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
  }
  nav li { flex: 0 0 auto; }
  nav a {
    text-decoration: none;
    color: #333;
    font-weight: bold;
    padding: 6px 10px;
    border-radius: 4px;
    display: inline-block;
  }
  nav a:hover,
  nav a.active {
    background-color: #7bd8a2;
    color: white;
  }

  main {
    max-width: 1000px;           /* èˆ‡åƒ¹ç›®è¡¨ç›¸åŒå¯¬åº¦ */
    margin: 140px auto 40px;           /* ä¸Šä¸‹é–“è· 40pxï¼Œå·¦å³ç½®ä¸­ */
    padding: 0px 20px;    /* ä¸Š 140px é¿é–‹ headerï¼Œå·¦å³ 20pxï¼Œä¸‹ 40px */
  }

  h1 {
    color: #4a7c53;
    margin-bottom: 20px;
    text-align: center;
  }

  form {
    background: #fff;
    padding: 20px 40px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    max-width: 500px;   /* é™åˆ¶è¡¨å–®å¯¬åº¦ */
    margin: 0 auto;     /* ç½®ä¸­ */
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #4a7c53;
  }

  select, input {
    width: 100%;
    padding: 10px;
    margin-bottom: 20px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 1rem;
  }

  button {
    background-color: #7bd8a2;
    border: none;
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:hover {
    background-color: #5bb174;
  }

  footer {
    margin-top: 60px;
    background: #a8e6cf;
    padding: 20px;
    text-align: center;
    font-size: 0.9rem;
  }

  footer a,
  footer a:visited {
    color: #333;
    text-decoration: none;
    margin: 0 8px;
  }

  footer a:hover {
    color: #4a7c53;
  }
</style>
</head>
<body>

<header>
  <h2>å¯è‰å…’ Hair Salon</h2>
  <nav>
    <ul>
      <li><a href="index.html">é¦–é </a></li>
      <li><a href="about.html">é—œæ–¼æˆ‘å€‘</a></li>
      <li><a href="services.html">æœå‹™é …ç›®</a></li>
      <li><a href="pricing.html">åƒ¹ç›®è¡¨</a></li>
      <li><a href="booking.html" class="active">é ç´„</a></li>
      <li><a href="news.html">æœ€æ–°æ¶ˆæ¯</a></li>
      <li><a href="contact.html">è¯çµ¡æˆ‘å€‘</a></li>
    </ul>
  </nav>
</header>

<main>
  <h1>ç·šä¸Šé ç´„</h1>
  <form id="booking-form">
    <label for="service">æœå‹™é …ç›®</label>
    <select id="service" name="service" required>
      <option value="" disabled selected>è«‹é¸æ“‡æœå‹™</option>
      <option value="å‰ªé«®">å‰ªé«®ï¼ˆç´„1å°æ™‚ï¼‰</option>
      <option value="æ´—é«®">æ´—é«®ï¼ˆç´„1å°æ™‚ï¼‰</option>
      <option value="ç‡™é«®">ç‡™é«®ï¼ˆç´„1å°æ™‚ï¼‰</option>
      <option value="æŸ“é«®">æŸ“é«®ï¼ˆç´„1å°æ™‚ï¼‰</option>
    </select>
    
    <label for="date">æ—¥æœŸ</label>
    <input type="date" id="date" name="date" required />
    
    <label for="time">æ™‚é–“</label>
    <select id="time" name="time" required>
      <option value="" disabled selected>è«‹é¸æ“‡æ™‚é–“</option>
      <option>10:00</option>
      <option>11:00</option>
      <option>13:00</option>
      <option>14:00</option>
      <option>15:00</option>
      <option>16:00</option>
      <option>17:00</option>
      <option>18:00</option>
      <option>19:00</option>
    </select>
    
    <label for="name">å§“å</label>
    <input type="text" id="name" name="name" placeholder="è«‹è¼¸å…¥å§“å" required />
    
    <label for="phone">é›»è©±</label>
    <input type="tel" id="phone" name="phone" placeholder="è«‹è¼¸å…¥é›»è©±" required />
    
    <button type="submit">é€å‡ºé ç´„</button>
  </form>
</main>

<footer>
  Â© 2025 å¯è‰å…’ Hair Salon <br>
  åœ°å€ï¼š514 å½°åŒ–ç¸£æºªæ¹–é®äºŒæºªè·¯ä¸€æ®µ329å··30è™Ÿ <br>
  é›»è©±ï¼š<a href="tel:0988528051">0988-528-051</a><br>
  ç‡Ÿæ¥­æ™‚é–“ï¼šé€±ä¸€è‡³é€±æ—¥ 11:00â€“20:00<br>
  <a href="https://www.facebook.com/share/17SjkpTezD/?mibextid=wwXIfr" target="_blank">Facebook</a> ï½œ 
  <a href="https://www.instagram.com/bijunzhan?igsh=dmdkbWRvbG1kd3Q0" target="_blank">Instagram</a> ï½œ
  <a href="https://line.me/R/ti/p/@491xwhjb" target="_blank">LINE</a>
</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  const LINE_API_URL = "https://script.google.com/macros/s/AKfycbzS0CAd3OX2iNJ3kqt8kx3bvCYe7-MPSdeXPtkXA-mjrR6lUJELJX3A0EH-KDRkJoPKaQ/exec";
  // ---------------- Firebase åˆå§‹åŒ– (ç¶­æŒä¸è®Š) ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyCfxDOOzTLbmQRfvW275hJrtOnX_t-6-yc",
    authDomain: "hsinformation.firebaseapp.com",
    projectId: "hsinformation",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const bookingForm = document.getElementById('booking-form');
  const dateInput = document.getElementById('date');
  const timeSelect = document.getElementById('time');
  const allTimes = ["10:00","11:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00"];

  // ==================== æ–°å¢åŠŸèƒ½ï¼šè¨­å®šæ—¥æœŸæœ€å°å€¼ ====================
  // å–å¾—ä»Šå¤©çš„æ—¥æœŸå­—ä¸²ï¼Œæ ¼å¼ç‚º YYYY-MM-DD
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0'); // è£œé›¶
  const day = String(today.getDate()).padStart(2, '0'); // è£œé›¶
  const todayString = `${year}-${month}-${day}`;

  // è¨­å®šæ—¥æœŸæ¬„ä½çš„ min å±¬æ€§ï¼Œè®“ä½¿ç”¨è€…ç„¡æ³•é¸æ“‡ä»Šå¤©ä¹‹å‰çš„æ—¥æœŸ
  dateInput.min = todayString;

  // ==================== ä¿®æ”¹åŠŸèƒ½ï¼šé¸æ“‡æ—¥æœŸæ™‚æª¢æŸ¥æ™‚é–“ ====================
  dateInput.addEventListener('change', async () => {
    const selectedDate = dateInput.value;
    if (!selectedDate) return;

    // 1. å…ˆå»è³‡æ–™åº«æŠ“å·²ç¶“è¢«é ç´„çš„æ™‚é–“
    const snapshot = await db.collection('appointments')
      .where('date', '==', selectedDate)
      .get();
    const bookedTimes = snapshot.docs.map(doc => doc.data().time);

    // 2. å–å¾—ç¾åœ¨çš„å°æ™‚ (0-23)
    const now = new Date();
    const currentHour = now.getHours();
    
    // 3. åˆ¤æ–·ä½¿ç”¨è€…é¸çš„æ—¥æœŸæ˜¯ä¸æ˜¯ã€Œä»Šå¤©ã€
    const isToday = (selectedDate === todayString);

    // 4. é‡ç½®ä¸¦ç”¢ç”Ÿæ™‚é–“é¸é …
    timeSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡æ™‚é–“</option>';

    allTimes.forEach(time => {
      const option = document.createElement('option');
      option.value = time;
      
      // å–å¾—è©²é¸é …çš„å°æ™‚æ•¸ (ä¾‹å¦‚ "14:00" -> 14)
      const timeHour = parseInt(time.split(':')[0]);

      // åˆ¤æ–·æ˜¯å¦ç‚ºéå»çš„æ™‚é–“ (åªåœ¨é¸æ“‡ä»Šå¤©æ™‚æª¢æŸ¥)
      // å¦‚æœæ˜¯ä»Šå¤©ï¼Œä¸”è©²é¸é …çš„æ™‚é–“ <= ç¾åœ¨æ™‚é–“ï¼Œå°±é–ä½
      // ä¾‹å¦‚ç¾åœ¨ 14:30ï¼Œé‚£éº¼ 14:00 åŠä¹‹å‰çš„éƒ½ä¸èƒ½ç´„
      const isPastTime = isToday && (timeHour <= currentHour);

      // åˆ¤æ–·æ˜¯å¦å·²è¢«é ç´„
      const isBooked = bookedTimes.includes(time);

      // é¡¯ç¤ºæ–‡å­—è™•ç†
      if (isPastTime) {
        option.textContent = `${time} (å·²è¶…éæ™‚é–“)`;
        option.disabled = true;
        option.style.color = '#ccc'; // ç°è‰²
      } else if (isBooked) {
        option.textContent = `${time} (å·²è¢«é ç´„)`;
        option.disabled = true;
        option.style.color = '#ccc'; // ç°è‰²
      } else {
        option.textContent = time; // æ­£å¸¸é¡¯ç¤º
      }

      timeSelect.appendChild(option);
    });
  });

  // é€å‡ºé ç´„ (ç¶­æŒä¸è®Š)
  // --- è«‹ç”¨é€™æ•´æ®µè¦†è“‹åŸæœ¬çš„ bookingForm ç›£è½å™¨ ---
  bookingForm.addEventListener('submit', async e => {
    e.preventDefault();

    const service = document.getElementById('service').value;
    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    
    // é–å®šæŒ‰éˆ•ï¼Œé¿å…é‡è¤‡æŒ‰
    const submitBtn = bookingForm.querySelector('button');
    submitBtn.disabled = true;
    submitBtn.textContent = "è™•ç†ä¸­...";

    try {
        // 1. å†æ¬¡æª¢æŸ¥æ˜¯å¦è¢«é ç´„ (é›™é‡ç¢ºèª)
        const snapshot = await db.collection('appointments')
          .where('date', '==', date)
          .where('time', '==', time)
          .get();

        if (!snapshot.empty) {
          alert("âŒ æ­¤æ™‚é–“å‰›å‰›å·²è¢«æ¶èµ°ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚æ®µ");
          submitBtn.disabled = false;
          submitBtn.textContent = "é€å‡ºé ç´„";
          return;
        }

        // 2. å­˜å…¥ Firebase
        await db.collection('appointments').add({
          memberName: name,
          memberId: phone,
          service: service,
          date: date,
          time: time,
          status: 'å·²é ç´„',
          note: '',
          createdAt: new Date()
        });

        // 3. ç™¼é€ LINE é€šçŸ¥çµ¦è€é—† (æ–°å¢çš„åŠŸèƒ½ï¼)
        const msg = `ã€æ–°é ç´„é€šçŸ¥ã€‘\nğŸ“… æ—¥æœŸ: ${date}\nâ° æ™‚é–“: ${time}\nğŸ‘¤ å®¢æˆ¶: ${name}\nğŸ“ é›»è©±: ${phone}\nğŸ’‡ é …ç›®: ${service}`;
        
        fetch(LINE_API_URL, {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify({ message: msg }),
          headers: { 'Content-Type': 'application/json' }
        }).catch(err => console.error('LINE é€šçŸ¥å¤±æ•—', err));

        // 4. æˆåŠŸæç¤º
        alert('âœ… é ç´„é€å‡ºæˆåŠŸï¼æˆ‘å€‘æœƒç›¡å¿«èˆ‡æ‚¨è¯çµ¡ç¢ºèªã€‚');
        bookingForm.reset();
        timeSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡æ™‚é–“</option>';

    } catch (error) {
        console.error(error);
        alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
    } finally {
        // è§£é–æŒ‰éˆ•
        submitBtn.disabled = false;
        submitBtn.textContent = "é€å‡ºé ç´„";
    }
  });
</script>

</body>
</html>

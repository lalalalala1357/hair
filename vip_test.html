<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VIP 管理 - 可莉兒 Hair Salon</title>
<style>
:root{--bg:#f7fff7;--cㄐard:#ffffff;--accent:#a8e6cf;--muted:#666}
body{font-family:Arial, Helvetica, sans-serif;background:var(--bg);margin:0;padding:0px}
header{background:#a8e6cf;padding:15px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;}
header h1{margin:0;color:#4a7c53;font-weight:bold;font-size:18px;}
nav ul{list-style:none;display:flex;gap:12px;margin:0;padding:0;}
nav a{text-decoration:none;color:#333;font-weight:bold;padding:6px 12px;border-radius:4px;}
nav a:hover, nav a.active{background:#7bd8a2;color:#fff;}
.container{max-width:1100px;margin:18px auto}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,0.05)}
.col{flex:1;min-width:280px}
input,button,select,textarea{font-size:14px;padding:8px;border-radius:6px;border:1px solid #ddd}
button{cursor:pointer}
.small{font-size:13px;color:var(--muted)}
.member-list{max-height:360px;overflow:auto;margin-top:8px}
table{width:100%;border-collapse:collapse}
td,th{padding:8px;border-bottom:1px solid #f0f0f0;text-align:left}
.actions button{margin-right:6px}
.flex{display:flex;gap:8px;align-items:center}
.topbar{display:flex;gap:8px;align-items:center;margin-top:12px}
.badge{padding:6px 8px;border-radius:999px;background:var(--accent);font-weight:600}
.muted{color:#888}
.hidden{display:none}
.toast{position:fixed;right:18px;bottom:18px;background:#222;color:#fff;padding:10px 14px;border-radius:8px}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <h1>可莉兒 Hair Salon</h1>
  <nav>
    <ul>
      <li><a href="#" class="active">VIP 管理</a></li>
      <li><a href="admin-calendar.html">行事曆管理</a></li>
    </ul>
  </nav>
</header>

<div class="container">
  <div id="loginCard" class="card" style="margin-top:12px;max-width:520px">
    <h3>請輸入管理密碼（單機測試，隨便輸入都可登入）</h3>
    <div class="topbar">
      <input id="adminPassword" placeholder="輸入管理密碼" type="password" />
      <button id="btnLogin">登入</button>
      <div class="small">密碼會被保存在此瀏覽器。</div>
    </div>
  </div>

  <div id="mainUI" class="hidden">
    <div class="row" style="margin-top:12px">
      <div class="card col" style="max-width:420px">
        <h3>新增 / 編輯 會員</h3>
        <div style="display:grid;gap:8px">
          <input id="phoneInput" placeholder="電話 (必填，作為會員識別)" />
          <input id="nameInput" placeholder="姓名 (必填)" />
          <input id="balanceInput" placeholder="初始儲值 (可為空，數字)" />
          <div class="flex">
            <button id="btnAdd">新增會員</button>
            <button id="btnUpdate" class="hidden">更新會員</button>
            <button id="btnClear">清除表單</button>
          </div>
          <div class="small muted">備註：電話將作為識別碼 (請勿重複)。</div>
        </div>
      </div>

      <div class="card col">
        <h3>搜尋會員 / 快速動作</h3>
        <div class="flex">
          <input id="searchPhone" placeholder="以電話搜尋" style="flex:1" />
          <button id="btnSearch">搜尋</button>
          <button id="btnShowAll">顯示最新會員</button>
        </div>

        <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="rechargeAmount" placeholder="儲值金額" />
          <input id="deductAmount" placeholder="扣款金額" />
          <button id="btnRecharge">確認儲值</button>
          <button id="btnDeduct">確認扣款</button>
        </div>

        <div class="member-list" id="memberList"></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card col">
        <h3>交易紀錄 / 修改紀錄</h3>
        <div class="small muted">近期交易會即時顯示</div>
        <div id="transList" style="max-height:360px;overflow:auto;margin-top:8px"></div>
      </div>

      <div class="card col" style="max-width:360px">
        <h3>客戶備注</h3>
        <textarea id="notesBox" rows="6" placeholder="客戶消費備註與回饋顯示在這裡"></textarea>
        <div style="margin-top:8px" class="flex">
          <button id="btnSaveNotes">儲存客戶備注</button>
          <button id="btnExportCSV">匯出會員CSV</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden">已儲存</div>
</div>

<script>
const ADMIN_FLAG = 'vip_admin_ok_v1'
let lastMembers = []
let lastTrans = []

// --------------- Firebase Config -----------------
const firebaseConfig = {
  apiKey: "AIzaSyAXbCW5UXRp085kJc9DjE5z2rbDJNFv47g",
  authDomain: "hair-salon-56eb5.firebaseapp.com",
  projectId: "hair-salon-56eb5",
  storageBucket: "hair-salon-56eb5.appspot.com",
  messagingSenderId: "64472921085",
  appId: "1:64472921085:web:78ba36b069597490625f94"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
// -----------------------------------------------

const loginCard = document.getElementById('loginCard')
const mainUI = document.getElementById('mainUI')
const btnLogin = document.getElementById('btnLogin')
const adminPassword = document.getElementById('adminPassword')
const toast = document.getElementById('toast')

const phoneInput = document.getElementById('phoneInput')
const nameInput = document.getElementById('nameInput')
const balanceInput = document.getElementById('balanceInput')
const btnAdd = document.getElementById('btnAdd')
const btnUpdate = document.getElementById('btnUpdate')
const btnClear = document.getElementById('btnClear')

const searchPhone = document.getElementById('searchPhone')
const btnSearch = document.getElementById('btnSearch')
const btnShowAll = document.getElementById('btnShowAll')
const memberList = document.getElementById('memberList')

const rechargeAmount = document.getElementById('rechargeAmount')
const deductAmount = document.getElementById('deductAmount')
const btnRecharge = document.getElementById('btnRecharge')
const btnDeduct = document.getElementById('btnDeduct')

const transList = document.getElementById('transList')
const notesBox = document.getElementById('notesBox')
const btnSaveNotes = document.getElementById('btnSaveNotes')
const btnExportCSV = document.getElementById('btnExportCSV')

function showToast(msg='已儲存', time=2000){
  toast.textContent = msg
  toast.classList.remove('hidden')
  setTimeout(()=>toast.classList.add('hidden'), time)
}

function checkLogin(){
  if(localStorage.getItem(ADMIN_FLAG)){
    loginCard.classList.add('hidden')
    mainUI.classList.remove('hidden')
    initFirestoreData()
  }
}
checkLogin()

btnLogin.addEventListener('click', ()=>{
  localStorage.setItem(ADMIN_FLAG,'1')
  loginCard.classList.add('hidden')
  mainUI.classList.remove('hidden')
  adminPassword.value=''
  initFirestoreData()
})

async function initFirestoreData(){
  try{
    const snapshot = await db.collection('members').get()
    lastMembers = snapshot.docs.map(doc=>({ id: doc.id, ...doc.data() }))

    // 將交易紀錄簡單組合，假設每次變動都有加入 members.collection('transactions') 
    lastTrans = []
    for(const m of lastMembers){
      const tsnap = await db.collection('members').doc(m.Phone).collection('transactions').get()
      tsnap.forEach(d=>lastTrans.push({ id:d.id, ...d.data() }))
    }

    const lastPhone = localStorage.getItem('lastSelectedPhone')
    if(lastPhone){
      const idx = lastMembers.findIndex(m=>m.Phone===lastPhone)
      if(idx>=0) populateFormForEdit(lastPhone)
    }

    renderMemberList(lastMembers)
    renderTransList(lastTrans)
  } catch(err){console.error(err); alert('讀取會員資料失敗')}
}

// 新增會員
btnAdd.addEventListener('click', async ()=>{
  const phone = phoneInput.value.trim()
  const name = nameInput.value.trim()
  const bal = parseFloat(balanceInput.value)||0
  if(!phone||!name){ alert('請填電話與姓名'); return }

  const memberRef = db.collection('members').doc(phone)
  const docSnap = await memberRef.get()
  if(docSnap.exists && !confirm('該電話已存在，要覆蓋嗎？')) return

  await memberRef.set({
    Name:name,
    Phone:phone,
    Balance:bal || 0,
    Note: '',
    JoinedAt: new Date()
  })

  // 建立交易紀錄
  await db.collection('members').doc(phone).collection('transactions').add({
    type:'create',          // 或 'edit', 'recharge', 'deduct'
    amount: bal,             // 或交易金額
    before: cur,             // 扣款/儲值時才有
    after: newBal,           // 扣款/儲值時才有
    note:'新增會員',          // 或其他說明
    Phone: phone,            // 這行一定要加
    createdAt: new Date()
  })

  showToast('會員已新增')
  clearForm()
  initFirestoreData()
})

btnClear.addEventListener('click', clearForm)
function clearForm(){
  phoneInput.value=''; nameInput.value=''; balanceInput.value='';
  btnUpdate.classList.add('hidden'); btnAdd.classList.remove('hidden')
  notesBox.value=''
  localStorage.removeItem('lastSelectedPhone')
}

btnSearch.addEventListener('click', ()=>{
  const p = searchPhone.value.trim()
  if(!p) return
  const results = lastMembers.filter(m=>m.Phone.includes(p))
  if(results.length===0) return alert('找不到會員')
  renderMemberList(results)
})

btnShowAll.addEventListener('click', ()=>{
  searchPhone.value=''
  renderMemberList(lastMembers)
})

btnUpdate.addEventListener('click', async ()=>{
  const phone = phoneInput.value.trim()
  const name = nameInput.value.trim()
  const bal = parseFloat(balanceInput.value)||0
  if(!phone||!name){ alert('請填電話與姓名'); return }

  await db.collection('members').doc(phone).update({
    Name:name,
    Balance:bal,
    Note: notesBox.value
  })

  await db.collection('members').doc(phone).collection('transactions').add({
    type:'edit',
    amount:bal,
    note:'更新會員資料',
    createdAt: new Date()
  })

  showToast('會員已更新')
  clearForm()
  initFirestoreData()
})

btnRecharge.addEventListener('click', ()=>transactionChange('recharge'))
btnDeduct.addEventListener('click', ()=>transactionChange('deduct'))

async function transactionChange(mode){
  const phone = searchPhone.value.trim() || phoneInput.value.trim()
  if(!phone) return alert('請在搜尋或表單中選擇會員')
  const amt = parseFloat(mode==='recharge'?rechargeAmount.value:deductAmount.value)
  if(!amt||isNaN(amt)) return alert('請輸入正確金額')

  const memberRef = db.collection('members').doc(phone)
  const docSnap = await memberRef.get()
  if(!docSnap.exists) return alert('找不到會員')

  const cur = docSnap.data().Balance || 0
  const newBal = mode==='recharge'?cur+amt:cur-amt

  await memberRef.update({ Balance:newBal })
  await memberRef.collection('transactions').add({
    type:mode,
    amount:amt,
    before:cur,
    after:newBal,
    note: mode==='recharge'?'手動儲值':'手動扣款',
    createdAt: new Date()
  })

  showToast(mode==='recharge'?'已儲值':'已扣款')
  rechargeAmount.value=''; deductAmount.value=''
  initFirestoreData()
}

function renderMemberList(list){
  if(!Array.isArray(list)) list=[]
  if(list.length===0){ memberList.innerHTML='<div class="small muted">目前沒有會員</div>'; return }
  const displayList = list.slice(-20).reverse()
  let html='<div style="max-height:300px;overflow:auto;"><table><thead><tr><th>電話</th><th>姓名</th><th>餘額</th><th>操作</th></tr></thead><tbody>'
  for(const m of displayList){
    html+=`<tr>
      <td>${m.Phone}</td>
      <td>${m.Name}</td>
      <td>${(m.Balance ?? 0).toFixed(2)}</td>
      <td class="actions">
        <button data-phone="${m.Phone}" class="btnEdit">編輯</button>
        <button data-phone="${m.Phone}" class="btnDel">刪除</button>
      </td>
    </tr>`
  }
  html+='</tbody></table></div>'
  memberList.innerHTML=html
  memberList.querySelectorAll('.btnEdit').forEach(b=>b.addEventListener('click',e=>{
    const phone=e.currentTarget.dataset.phone
    populateFormForEdit(phone)
  }))
  memberList.querySelectorAll('.btnDel').forEach(b=>b.addEventListener('click',async e=>{
    const phone=e.currentTarget.dataset.phone
    if(confirm('確定刪除此會員？')){
      await db.collection('members').doc(phone).delete()
      showToast('會員已刪除')
      clearForm()
      initFirestoreData()
    }
  }))
}

function populateFormForEdit(phone){
  const idx = lastMembers.findIndex(m=>m.Phone===phone)
  if(idx<0) return alert('找不到會員')
  const m = lastMembers[idx]
  phoneInput.value = m.Phone
  nameInput.value = m.Name
  balanceInput.value = m.Balance
  notesBox.value = m.Note || ''
  btnUpdate.classList.remove('hidden'); btnAdd.classList.add('hidden')

  localStorage.setItem('lastSelectedPhone', phone)
}

function renderTransList(list){
  if(!list.length){ transList.innerHTML='<div class="small muted">目前無交易紀錄</div>'; return }
  const displayList = list.slice(-50).reverse()
  let html='<table><thead><tr><th>時間</th><th>電話</th><th>類型</th><th>金額</th><th>備註</th></tr></thead><tbody>'
  for(const t of displayList){
    const dt = new Date(t.createdAt.seconds? t.createdAt.toDate() : t.createdAt).toLocaleString()
    html+=`<tr>
      <td>${dt}</td>
      <td>${t.phone || t.Phone}</td>
      <td>${t.type}</td>
      <td>${t.amount}</td>
      <td>${t.note||''}</td>
    </tr>`
  }
  html+='</tbody></table>'
  transList.innerHTML=html
}

btnSaveNotes.addEventListener('click', async ()=>{
  const phone = phoneInput.value.trim()
  if(!phone) return alert('請先選擇或輸入會員')
  const note = notesBox.value
  await db.collection('members').doc(phone).update({ Note: note })
  showToast('備註已儲存（本會員）')
  initFirestoreData()
})

btnExportCSV.addEventListener('click', ()=>{
  if(!lastMembers.length) return alert('沒有會員可匯出')
  const rows=[['phone','name','balance']]
  for(const m of lastMembers) rows.push([m.Phone,m.Name,m.Balance])
  const csv = rows.map(r=> r.map(c=> '"'+(''+c).replace(/"/g,'""')+'"').join(',')).join('\n')
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'})
  const url = URL.createObjectURL(blob)
  const a=document.createElement('a'); a.href=url; a.download='vip_members.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
})
</script>
</body>
</html>

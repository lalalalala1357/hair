<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VIP 管理 - 可莉兒 Hair Salon</title>
<style>
:root{
  --bg:#f7fff7;
  --card:#ffffff;
  --accent:#a8e6cf;
  --muted:#666;
  --btn:#ccc;
}
body{
  font-family:Arial, Helvetica, sans-serif;
  background:var(--bg);
  margin:0;
  padding:0;
}
header{
  background:#a8e6cf;
  padding:15px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}
header h1{
  margin:0;
  color:#4a7c53;
  font-weight:bold;
  font-size:18px;
}
nav ul{
  list-style:none;
  display:flex;
  gap:12px;
  margin:0;
  padding:0;
  overflow-x:auto;
  white-space:nowrap;
  -webkit-overflow-scrolling:touch;
}
nav a{
  text-decoration:none;
  color:#333;
  font-weight:bold;
  padding:6px 12px;
  border-radius:4px;
  flex-shrink:0;
}
nav a:hover, nav a.active{
  background:#7bd8a2;
  color:#fff;
}
.container{max-width:1100px;margin:18px auto}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,0.05)}
.col{flex:1;min-width:280px}
input,button,select,textarea{font-size:14px;padding:8px;border-radius:6px;border:1px solid #ddd}
button{cursor:pointer;background:var(--btn);border:none}
.small{font-size:13px;color:var(--muted)}
.member-list{max-height:360px;overflow:auto;margin-top:8px}
table{width:100%;border-collapse:collapse}
td,th{padding:8px;border-bottom:1px solid #f0f0f0;text-align:left}
.actions button{margin-right:6px}
.flex{display:flex;gap:8px;align-items:center}
.topbar{display:flex;gap:8px;align-items:center;margin-top:12px}
.badge{padding:6px 8px;border-radius:999px;background:var(--accent);font-weight:600}
.muted{color:#888}
.hidden{display:none}
.toast{position:fixed;right:18px;bottom:18px;background:#222;color:#fff;padding:10px 14px;border-radius:8px}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <h1>可莉兒 Hair Salon - 管理後台</h1>
  <nav>
    <ul>
      <li><a href="admin-calendar.html">行事曆管理</a></li>
      <li><a href="vip_test.html" class="active">VIP管理</a></li>
      <li><a href="admin-news.html">公告管理</a></li>
    </ul>
  </nav>
</header>

<div class="container">
<!-- 登入卡 -->
<div id="loginCard" class="card" style="margin-top:12px;max-width:520px">
<h3>請輸入管理密碼</h3>
<div class="topbar">
<input id="adminPassword" placeholder="輸入管理密碼" type="password" />
<button id="btnLogin">登入</button>
<div class="small">密碼會被保存在此瀏覽器。</div>
</div>
</div>

<!-- 主畫面 -->
<div id="mainUI" class="hidden">
<div class="row" style="margin-top:12px">
<!-- 新增 / 編輯會員 -->
<div class="card col" style="max-width:420px">
<h3>新增 / 編輯 會員</h3>
<div style="display:grid;gap:8px">
<input id="phoneInput" placeholder="電話 (必填，作為會員識別)" />
<input id="nameInput" placeholder="姓名 (必填)" />
<input id="balanceInput" placeholder="初始儲值 (可為空，數字)" />
<div class="flex">
<button id="btnAdd">新增會員</button>
<button id="btnUpdate" class="hidden">更新會員</button>
<button id="btnClear">清除表單</button>
</div>
<div class="small muted">備註：電話將作為識別碼 (請勿重複)。</div>
</div>
</div>

<!-- 搜尋 / 儲值扣款 -->
<div class="card col">
<h3>搜尋會員 / 快速動作</h3>
<div class="flex">
<input id="searchPhone" placeholder="以電話搜尋" style="flex:1" />
<button id="btnSearch">搜尋</button>
<button id="btnShowAll">顯示最新會員</button>
</div>

<div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
<input id="rechargeAmount" placeholder="儲值金額" />
<input id="deductAmount" placeholder="扣款金額" />
<button id="btnRecharge">確認儲值</button>
<button id="btnDeduct">確認扣款</button>
</div>

<div class="member-list" id="memberList"></div>
</div>
</div>

<div class="row" style="margin-top:12px">
<!-- 交易紀錄 -->
<div class="card col">
<h3>交易紀錄 / 修改紀錄</h3>
<div class="small muted">近期交易會即時顯示</div>
<div id="transList" style="max-height:360px;overflow:auto;margin-top:8px"></div>
</div>

<!-- 客戶備注 -->
<div class="card col" style="max-width:360px">
<h3>客戶備注</h3>
<textarea id="notesBox" rows="6" placeholder="客戶消費備註與回饋顯示在這裡"></textarea>
<div style="margin-top:8px" class="flex">
<button id="btnSaveNotes">儲存客戶備注</button>
<button id="btnExportCSV">匯出會員CSV</button>
</div>
</div>
</div>
</div>

<div id="toast" class="toast hidden">已儲存</div>
</div>

<script>
const ADMIN_FLAG = 'vip_admin_ok_v1'
let lastMembers = []
let lastTrans = []

// TODO: 換成你自己的 Firebase 設定
const firebaseConfig = {
  apiKey: "AIzaSyAXbCW5UXRp085kJc9DjE5z2rbDJNFv47g",
  authDomain: "hair-salon-56eb5.firebaseapp.com",
  projectId: "hair-salon-56eb5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore()

// 元件
const loginCard = document.getElementById('loginCard')
const mainUI = document.getElementById('mainUI')
const btnLogin = document.getElementById('btnLogin')
const toast = document.getElementById('toast')
const phoneInput = document.getElementById('phoneInput')
const nameInput = document.getElementById('nameInput')
const balanceInput = document.getElementById('balanceInput')
const btnAdd = document.getElementById('btnAdd')
const btnUpdate = document.getElementById('btnUpdate')
const btnClear = document.getElementById('btnClear')
const searchPhone = document.getElementById('searchPhone')
const btnSearch = document.getElementById('btnSearch')
const btnShowAll = document.getElementById('btnShowAll')
const memberList = document.getElementById('memberList')
const rechargeAmount = document.getElementById('rechargeAmount')
const deductAmount = document.getElementById('deductAmount')
const btnRecharge = document.getElementById('btnRecharge')
const btnDeduct = document.getElementById('btnDeduct')
const transList = document.getElementById('transList')
const notesBox = document.getElementById('notesBox')
const btnSaveNotes = document.getElementById('btnSaveNotes')
const btnExportCSV = document.getElementById('btnExportCSV')

// Toast
function showToast(msg='已儲存', time=2000){
  toast.textContent = msg
  toast.classList.remove('hidden')
  setTimeout(()=>toast.classList.add('hidden'), time)
}

// 登入
function checkLogin(){
  if(localStorage.getItem(ADMIN_FLAG)){
    loginCard.classList.add('hidden')
    mainUI.classList.remove('hidden')
    initFirestoreData()
  }
}
checkLogin()
btnLogin.addEventListener('click', ()=>{
  const pw = document.getElementById('adminPassword').value
  if(!pw) return alert('請輸入密碼')
  localStorage.setItem(ADMIN_FLAG,'1')
  loginCard.classList.add('hidden')
  mainUI.classList.remove('hidden')
  initFirestoreData()
})

// Firestore 讀取會員與交易紀錄
async function initFirestoreData(){
  try{
    const snapshot = await db.collection('members').get()
    lastMembers = snapshot.docs.map(doc=>({ id: doc.id, ...doc.data() }))

    lastTrans = []
    for(const m of lastMembers){
      const tsnap = await db.collection('members').doc(m.Phone).collection('transactions').get()
      tsnap.forEach(d=>{
        const data = d.data()
        lastTrans.push({ id:d.id, Phone: m.Phone, ...data })
      })
    }

    lastTrans.sort((a,b)=>{
      const tA = a.createdAt?.seconds ? a.createdAt.toDate().getTime() : new Date(a.createdAt).getTime()
      const tB = b.createdAt?.seconds ? b.createdAt.toDate().getTime() : new Date(b.createdAt).getTime()
      return tB - tA
    })

    renderMemberList(lastMembers)
    renderTransList(lastTrans)
  } catch(err){console.error(err); alert('讀取會員資料失敗')}
}

// 新增會員
btnAdd.addEventListener('click', async ()=>{
  const phone = phoneInput.value.trim()
  const name = nameInput.value.trim()
  const bal = parseFloat(balanceInput.value)||0
  if(!phone||!name){ alert('請填電話與姓名'); return }

  const memberRef = db.collection('members').doc(phone)
  const docSnap = await memberRef.get()
  if(docSnap.exists && !confirm('該電話已存在，要覆蓋嗎？')) return

  await memberRef.set({
    Name:name,
    Phone:phone,
    Balance:bal,
    Note:'',
    JoinedAt:new Date()
  })

  await memberRef.collection('transactions').add({
    type:'create',
    amount:bal,
    before:0,
    after:bal,
    note:'新增會員',
    Phone:phone,
    createdAt:new Date()
  })

  showToast('會員已新增')
  clearForm()
  initFirestoreData()
})

// 清空表單
btnClear.addEventListener('click', clearForm)
function clearForm(){
  phoneInput.value=''; nameInput.value=''; balanceInput.value='';
  btnUpdate.classList.add('hidden'); btnAdd.classList.remove('hidden')
  notesBox.value=''
}

// 搜尋 / 顯示所有
btnSearch.addEventListener('click', ()=>{
  const p = searchPhone.value.trim()
  if(!p) return
  const results = lastMembers.filter(m=>m.Phone.includes(p))
  if(results.length===0) return alert('找不到會員')
  renderMemberList(results)
})
btnShowAll.addEventListener('click', ()=>{
  searchPhone.value=''
  renderMemberList(lastMembers)
})

// 編輯會員
btnUpdate.addEventListener('click', async ()=>{
  const phone = phoneInput.value.trim()
  const name = nameInput.value.trim()
  const bal = parseFloat(balanceInput.value)||0
  if(!phone||!name){ alert('請填電話與姓名'); return }

  await db.collection('members').doc(phone).update({
    Name:name,
    Balance:bal,
    Note: notesBox.value
  })

  await db.collection('members').doc(phone).collection('transactions').add({
    type:'edit',
    amount:bal,
    before:0,
    after:bal,
    note:'更新會員資料',
    Phone: phone,
    createdAt: new Date()
  })

  showToast('會員已更新')
  clearForm()
  initFirestoreData()
})

// 儲值 / 扣款
btnRecharge.addEventListener('click', ()=>transactionChange('recharge'))
btnDeduct.addEventListener('click', ()=>transactionChange('deduct'))
async function transactionChange(mode){
  const phone = searchPhone.value.trim() || phoneInput.value.trim()
  if(!phone) return alert('請選擇會員')
  const amt = parseFloat(mode==='recharge'?rechargeAmount.value:deductAmount.value)
  if(!amt||isNaN(amt)) return alert('請輸入金額')

  const memberRef = db.collection('members').doc(phone)
  const docSnap = await memberRef.get()
  if(!docSnap.exists) return alert('找不到會員')

  const cur = docSnap.data().Balance || 0

  // 新增：扣款不能超過餘額
  if(mode==='deduct' && amt > cur){
    return alert(`扣款金額 (${amt.toFixed(2)}) 超過目前餘額 (${cur.toFixed(2)})，請先讓客戶儲值！`)
  }

  const newBal = mode==='recharge'?cur+amt:cur-amt

  await memberRef.update({ Balance:newBal })
  await memberRef.collection('transactions').add({
    type:mode,
    amount:amt,
    before:cur,
    after:newBal,
    note: mode==='recharge'?'手動儲值':'手動扣款',
    Phone: phone,
    createdAt:new Date()
  })

  showToast(mode==='recharge'?'已儲值':'已扣款')
  rechargeAmount.value=''; deductAmount.value=''
  initFirestoreData()
}

// 渲染會員列表
function renderMemberList(list){
  if(!Array.isArray(list)) list=[]
  if(list.length===0){ memberList.innerHTML='<div class="small muted">目前沒有會員</div>'; return }
  const displayList = list.slice(-20).reverse()
  let html='<div style="max-height:300px;overflow:auto;"><table><thead><tr><th>電話</th><th>姓名</th><th>餘額</th><th>操作</th></tr></thead><tbody>'
  for(const m of displayList){
    html+=`<tr>
      <td>${m.Phone}</td>
      <td>${m.Name}</td>
      <td>${(m.Balance ?? 0).toFixed(2)}</td>
      <td class="actions">
        <button data-phone="${m.Phone}" class="btnEdit">編輯</button>
        <button data-phone="${m.Phone}" class="btnDel">刪除</button>
      </td>
    </tr>`
  }
  html+='</tbody></table></div>'
  memberList.innerHTML=html

  memberList.querySelectorAll('.btnEdit').forEach(b=>b.addEventListener('click',e=>{
    const phone=e.currentTarget.dataset.phone
    populateFormForEdit(phone)
  }))
  memberList.querySelectorAll('.btnDel').forEach(b=>b.addEventListener('click',async e=>{
    const phone=e.currentTarget.dataset.phone
    if(confirm('確定刪除此會員？')){
      await db.collection('members').doc(phone).delete()
      showToast('會員已刪除')
      clearForm()
      initFirestoreData()
    }
  }))
}

// 編輯表單填入
function populateFormForEdit(phone){
  const idx = lastMembers.findIndex(m=>m.Phone===phone)
  if(idx<0) return alert('找不到會員')
  const m = lastMembers[idx]
  phoneInput.value = m.Phone
  nameInput.value = m.Name
  balanceInput.value = m.Balance
  notesBox.value = m.Note || ''
  btnUpdate.classList.remove('hidden'); btnAdd.classList.add('hidden')
}

// 交易紀錄
function renderTransList(list){
  if(!list.length){ 
    transList.innerHTML='<div class="small muted">目前無交易紀錄</div>'; 
    return 
  }
  let html='<table><thead><tr><th>時間</th><th>電話</th><th>類型</th><th>金額</th><th>備註</th></tr></thead><tbody>'
  for(const t of list){
    const dt = t.createdAt?.seconds ? t.createdAt.toDate().toLocaleString() : new Date(t.createdAt).toLocaleString()
    let amountStr = t.before !== undefined && t.after !== undefined ? `${t.before.toFixed(2)} → ${t.after.toFixed(2)}` : t.amount?.toFixed(2) || ''
    html+=`<tr>
      <td>${dt}</td>
      <td>${t.Phone}</td>
      <td>${t.type}</td>
      <td>${amountStr}</td>
      <td>${t.note||''}</td>
    </tr>`
  }
  html+='</tbody></table>'
  transList.innerHTML=html
}

// 儲存備註
btnSaveNotes.addEventListener('click', async ()=>{
  const phone = phoneInput.value.trim()
  if(!phone) return alert('請選擇會員')
  const note = notesBox.value
  await db.collection('members').doc(phone).update({ Note: note })
  showToast('備注已儲存')
  initFirestoreData()
})

// 匯出 CSV
btnExportCSV.addEventListener('click', ()=>{
  if(!lastMembers.length){ alert('無會員資料'); return }
  let csv = '電話,姓名,餘額,備註,加入時間\n'
  lastMembers.forEach(m=>{
    const joined = m.JoinedAt?.seconds ? m.JoinedAt.toDate().toLocaleString() : (m.JoinedAt || '')
    csv += `${m.Phone||''},${m.Name||''},${m.Balance||0},${m.Note||''},${joined}\n`
  })
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  link.download = 'VIP會員資料.csv'
  link.click()
})
</script>
</body>
</html>
